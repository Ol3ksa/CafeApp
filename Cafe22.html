<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–°–∏—Å—Ç–µ–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å –∫–∞—Ñ–µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    button {
      cursor: pointer;
      touch-action: manipulation; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–æ–¥–≤—ñ–π–Ω–æ–º—É —Ç–∞–ø—É –∑—É–º—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
      -webkit-tap-highlight-color: transparent; /* –ü—Ä–∏–±–∏—Ä–∞—î –ø—ñ–¥—Å–≤—ñ—Ç–∫—É –ø—Ä–∏ —Ç–∞–ø—ñ –Ω–∞ iOS */
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .mode-select {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
      gap: 16px;
    }

    .mode-select h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }

    .mode-select p {
      margin: 0 0 16px;
      font-size: 16px;
      color: #4b5563;
    }

    .mode-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    .btn {
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      background: #2563eb;
      color: white;
      font-size: 15px;
      transition: background 0.15s ease, transform 0.05s ease;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .btn.secondary {
      background: #6b7280;
    }

    .btn.danger {
      background: #b91c1c;
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 13px;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn:hover {
      background: #1d4ed8;
    }

    .btn.secondary:hover {
      background: #4b5563;
    }

    .btn.danger:hover {
      background: #991b1b;
    }

    /* admin view */

    #adminView {
      min-height: 100vh;
    }

    .admin-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .admin-header > div:first-child {
      flex: 1;
      min-width: 0;
    }

    .admin-header-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }

    .admin-header-sub {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
      margin-bottom: 2px;
    }

    .status-legend {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
      line-height: 1.4;
    }

    .sync-status {
      font-size: 11px;
      color: #16a34a;
      min-height: 16px;
      margin-top: 4px;
    }

    .sync-status.error {
      color: #b91c1c;
    }

    .admin-header-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
      flex-shrink: 0;
    }

    .admin-header-right .btn {
      white-space: nowrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: #e5e7eb;
      color: #374151;
    }

    .admin-form {
      background: white;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      margin-bottom: 18px;
    }

    .admin-form-title {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .admin-form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .admin-form label {
      font-size: 13px;
      color: #4b5563;
    }

    .admin-form input,
    .admin-form textarea {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      width: 100%;
      resize: vertical;
      min-height: 36px;
    }

    .admin-form input:focus,
    .admin-form textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .menu-builder {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 12px 0;
    }

    .menu-category {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
      background: #f9fafb;
    }

    .menu-category-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #374151;
    }

    .menu-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .menu-item-card {
      border-radius: 12px;
      background: white;
      border: 1px solid #dbeafe;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 90px;
      justify-content: space-between;
    }

    .menu-item-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    .menu-item-price {
      font-size: 13px;
      color: #475569;
    }

    .menu-item-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .counter-btn {
      border: none;
      background: #e5e7eb;
      color: #111827;
      font-size: 18px;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      line-height: 1;
      font-weight: 600;
      touch-action: manipulation; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–æ–¥–≤—ñ–π–Ω–æ–º—É —Ç–∞–ø—É –∑—É–º—É */
      -webkit-tap-highlight-color: transparent;
    }

    .counter-btn:active {
      transform: scale(0.94);
    }

    .menu-count {
      font-size: 16px;
      font-weight: 600;
      min-width: 32px;
      text-align: center;
    }

    .builder-toolbar {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
    }

    .manual-extra-row {
      margin-top: 8px;
    }

    .manual-extra-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .manual-extra-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
    }

    .manual-extra-chip {
      border: 1px solid #dbeafe;
      border-radius: 12px;
      padding: 8px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .manual-chip-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #1e293b;
      font-weight: 600;
    }

    .manual-chip-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .manual-chip-controls .menu-item-controls {
      flex: 1;
    }

    .manual-chip-remove {
      border: none;
      background: transparent;
      color: #dc2626;
      font-size: 12px;
      cursor: pointer;
    }

    .admin-form-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    /* –ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏ */
    .search-bar {
      background: white;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.05);
    }

    .search-bar input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .quick-action-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .quick-action-btn:hover {
      background: #f3f4f6;
      border-color: #2563eb;
    }

    .quick-action-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    /* –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –º–µ–Ω—é –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è */
    .menu-category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .menu-category-toggle {
      font-size: 18px;
      color: #6b7280;
      transition: transform 0.2s ease;
    }

    .menu-category.collapsed .menu-items {
      display: none;
    }

    .menu-category.collapsed .menu-category-toggle {
      transform: rotate(-90deg);
    }

    /* –®–≤–∏–¥–∫–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è */
    .last-order-quick {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 12px;
      display: none;
    }

    .last-order-quick.show {
      display: block;
    }

    .last-order-quick-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .last-order-quick-title {
      font-size: 13px;
      font-weight: 600;
      color: #1e40af;
    }

    .last-order-quick-content {
      font-size: 12px;
      color: #475569;
      margin-bottom: 8px;
    }

    .last-order-quick-btn {
      padding: 6px 12px;
      font-size: 12px;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
    }

    /* –®–≤–∏–¥–∫—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó */
    .quick-combos {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .quick-combo-btn {
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid #2563eb;
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      color: #1e40af;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }

    .quick-combo-btn:active {
      transform: scale(0.95);
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    }

    .quick-combo-btn:hover {
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    /* –†–µ–∂–∏–º —à–≤–∏–¥–∫–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è */
    .quick-mode-active .admin-form-row:not(.quick-mode-show) {
      display: none;
    }

    .quick-mode-active .quick-mode-show {
      display: flex !important;
    }

    .quick-mode-active #quickCombosRow {
      display: flex !important;
    }

    #quickModeBtn.active {
      background: #fbbf24;
      color: #78350f;
      border-color: #f59e0b;
    }

    /* –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —ñ–º–µ–Ω */
    #orderName {
      position: relative;
    }

    datalist {
      position: absolute;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
    }

    datalist option {
      padding: 8px 12px;
      cursor: pointer;
    }

    datalist option:hover {
      background: #f3f4f6;
    }

    /* Analytics view */
    #analyticsView {
      min-height: 100vh;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .analytics-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    .analytics-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .analytics-card-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .analytics-card-subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    .analytics-chart {
      margin-top: 24px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
    }

    .analytics-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .analytics-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 14px;
    }

    .analytics-list-item-label {
      color: #374151;
    }

    .analytics-list-item-value {
      font-weight: 600;
      color: #111827;
    }

    .btn.ghost {
      background: transparent;
      color: #2563eb;
      border: 1px solid rgba(37, 99, 235, 0.3);
    }

    .btn.tiny {
      padding: 4px 8px;
      font-size: 12px;
    }

    .text-button {
      background: none;
      border: none;
      color: #2563eb;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .text-button:hover {
      text-decoration: underline;
    }

    .order-summary {
      margin-top: 12px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .order-summary-items {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: #0f172a;
    }

    .order-summary-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .order-summary-total {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .payment-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: #475569;
    }

    .payment-row input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .order-finance-info {
      font-size: 13px;
      color: #334155;
      display: flex;
      justify-content: space-between;
    }

    .admin-columns {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .admin-columns {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* –ö–Ω–æ–ø–∫–∞ scroll to top */
    .scroll-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #2563eb;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .scroll-to-top.visible {
      display: flex;
    }

    .scroll-to-top:active {
      transform: scale(0.95);
    }

    @media (max-width: 640px) {
      .admin-columns {
        grid-template-columns: 1fr;
      }

      /* –ú–æ–±—ñ–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–ª—è –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ */
      .app {
        padding: 8px;
      }

      .admin-header {
        position: sticky;
        top: 0;
        background: #f3f4f6;
        padding: 6px 0;
        margin-bottom: 8px;
        z-index: 100;
        border-bottom: 1px solid #e5e7eb;
      }

      .admin-header > div:first-child {
        position: relative;
        padding-right: 50px;
      }

      .admin-header-title {
        font-size: 16px;
        margin-bottom: 2px;
      }

      .admin-header-sub {
        font-size: 11px;
        line-height: 1.3;
      }

      /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—ñ–≤ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
      .status-legend {
        display: none;
      }

      /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤ header –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
      /* –í–∏–ø–∞–¥–∞—é—á–µ –º–µ–Ω—é –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
      .admin-header-right {
        display: none;
      }

      .mobile-menu-btn {
        display: block;
        position: absolute;
        top: 6px;
        right: 8px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: white;
        font-size: 20px;
        cursor: pointer;
        z-index: 101;
      }

      .mobile-menu {
        position: fixed;
        top: 0;
        right: -100%;
        width: 70%;
        max-width: 280px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        transition: right 0.3s ease;
        padding: 60px 16px 16px;
        overflow-y: auto;
      }

      .mobile-menu.open {
        right: 0;
      }

      .mobile-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }

      .mobile-menu-overlay.show {
        display: block;
      }

      .mobile-menu-item {
        display: block;
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        text-align: left;
        border-radius: 8px;
      }

      .mobile-menu-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }
    }

    /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –º–æ–±—ñ–ª—å–Ω–µ –º–µ–Ω—é –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ */
    @media (min-width: 641px) {
      .mobile-menu-btn,
      .mobile-menu,
      .mobile-menu-overlay {
        display: none !important;
      }

      /* –ö–æ–º–ø–∞–∫—Ç–Ω–∏–π sync status */
      .sync-status {
        font-size: 10px;
        min-height: 14px;
      }

      .admin-form {
        padding: 12px;
        margin-bottom: 12px;
      }

      .admin-form-title {
        font-size: 16px;
      }

      /* –ë—ñ–ª—å—à—ñ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
      .menu-item-card {
        min-height: 100px;
        padding: 12px;
      }

      .menu-item-title {
        font-size: 15px;
      }

      .counter-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .menu-count {
        font-size: 18px;
        min-width: 40px;
      }

      /* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ—à–µ –º–µ–Ω—é */
      .menu-items {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .menu-category {
        padding: 10px;
      }

      /* Sticky –∫–Ω–æ–ø–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è */
      .admin-form-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 12px 0;
        margin-top: 12px;
        border-top: 2px solid #e5e7eb;
        z-index: 50;
      }

      .admin-form-footer .btn {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
      }

      /* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω—å */
      .status-column {
        padding: 8px;
      }

      .order-card {
        padding: 10px;
      }

      .order-number {
        font-size: 20px;
      }

      /* –ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏ */
      .search-bar {
        margin-bottom: 12px;
      }

      .search-bar input {
        font-size: 16px; /* –∑–∞–ø–æ–±—ñ–≥–∞—î zoom –Ω–∞ iOS */
      }

      /* –ö–Ω–æ–ø–∫–∞ scroll to top –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
      .scroll-to-top {
        bottom: 16px;
        right: 16px;
        width: 48px;
        height: 48px;
        font-size: 22px;
      }
    }

    .status-column {
      background: white;
      border-radius: 16px;
      padding: 10px;
      min-height: 120px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-title {
      font-size: 14px;
      color: #4b5563;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .status-count {
      font-size: 12px;
      color: #6b7280;
    }

    .orders-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .order-card {
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .order-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .order-number {
      font-size: 18px;
      font-weight: 600;
    }

    .order-name {
      font-size: 13px;
      color: #4b5563;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .order-time {
      font-size: 11px;
      color: #9ca3af;
    }

    .order-items {
      font-size: 13px;
      color: #111827;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .order-item-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .order-finance {
      font-size: 12px;
      color: #475569;
      margin-top: 4px;
    }

    .order-note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
      font-style: italic;
    }

    .order-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .empty {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 8px;
    }

    /* screen view */

    #screenView {
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827, #020617);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .screen-inner {
      width: 100%;
      max-width: 1100px;
      text-align: center;
      position: relative;
    }

    .screen-title {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .screen-sub {
      font-size: 16px;
      color: #9ca3af;
      margin-bottom: 24px;
    }

    .ready-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-bottom: 16px;
    }

    .ready-item {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      padding: clamp(18px, 4vw, 36px);
      border-radius: 22px;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(42px, 8vw, 72px);
      font-weight: 800;
      box-shadow: 0 18px 50px rgba(22, 163, 74, 0.45);
      border: 4px solid rgba(255, 255, 255, 0.12);
    }

    .ready-item.pop {
      animation: readyPop 0.7s ease;
    }

    @keyframes readyPop {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      60% {
        transform: scale(1.05);
        opacity: 1;
      }
      100% {
        transform: scale(1);
      }
    }

    .screen-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 16px;
      font-size: 16px;
      color: #f1f5f9;
    }

    .screen-meta strong {
      color: #facc15;
    }

    .recent-done {
      margin-top: 12px;
      font-size: 15px;
      color: #a5b4fc;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .recent-done-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(15, 23, 42, 0.4);
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, 0.1);
    }

    .screen-footer {
      font-size: 14px;
      color: #9ca3af;
    }

    .screen-footer span {
      color: #e5e7eb;
    }

    /* in-progress grid on guest screen */

    .inprogress-section-title {
      margin-top: 24px;
      margin-bottom: 8px;
      font-size: 18px;
      color: #e5e7eb;
    }

    .inprogress-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 8px;
    }

    .inprogress-item {
      background: radial-gradient(circle at top, #4b5563, #020617);
      border-radius: 18px;
      padding: 16px 12px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.7);
      border: 2px solid rgba(148, 163, 184, 0.6);
      animation: inProgressPulse 2.4s ease-in-out infinite;
    }

    .inprogress-item-number {
      font-size: clamp(30px, 5vw, 44px);
      font-weight: 800;
      letter-spacing: 0.06em;
      color: #e5e7eb;
    }

    .inprogress-item-label {
      margin-top: 4px;
      font-size: 13px;
      color: #e5e7eb;
      opacity: 0.9;
    }

    @keyframes inProgressPulse {
      0% {
        transform: translateY(0);
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.7);
      }
      50% {
        transform: translateY(-3px);
        box-shadow: 0 18px 40px rgba(30, 64, 175, 0.55);
      }
      100% {
        transform: translateY(0);
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.7);
      }
    }

    .screen-no-orders {
      font-size: 20px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .screen-hint {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    .selected-role {
      font-size: 15px;
      color: #111827;
    }

    .login-form {
      display: none;
      flex-direction: column;
      gap: 10px;
      width: min(320px, 90vw);
      margin-top: 12px;
    }

    .login-form.active {
      display: flex;
    }

    .login-form input {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 15px;
    }

    .login-form input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .login-error {
      font-size: 13px;
      color: #b91c1c;
      min-height: 18px;
    }

    #screenLogoutBtn {
      position: fixed;
      top: 16px;
      right: 16px;
      margin: 0;
      z-index: 100;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–∏–±–æ—Ä—É —Å–º–∞–∫—É —á–∞—é */
    .flavor-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .flavor-modal-overlay.show {
      display: flex;
    }

    .flavor-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      z-index: 2001;
    }

    .flavor-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #111827;
    }

    .flavor-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .flavor-option {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
      font-size: 15px;
      text-align: left;
    }

    .flavor-option:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .flavor-option.selected {
      border-color: #2563eb;
      background: #dbeafe;
      font-weight: 600;
    }

    .flavor-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div id="loginView" class="mode-select">
    <h1>–°–∏—Å—Ç–µ–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å –∫–∞—Ñ–µ</h1>
    <p>–û–±–µ—Ä—ñ—Ç—å —Ä–æ–ª—å —Ç–∞ –≤–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å, —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏.</p>
    <div class="mode-buttons">
      <button class="btn" onclick="selectRole('admin')">–Ø –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫ (–≤–≤–æ–¥–∂—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è)</button>
      <button class="btn secondary" onclick="selectRole('screen')">–Ø –≤–µ–ª–∏–∫–∏–π –µ–∫—Ä–∞–Ω –¥–ª—è –≥–æ—Å—Ç–µ–π</button>
    </div>
    <div class="selected-role" id="selectedRoleInfo" style="display:none;">
      –û–±—Ä–∞–Ω–∞ —Ä–æ–ª—å: <span id="selectedRoleText"></span>
    </div>
    <div class="login-form" id="loginForm">
      <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" />
      <button class="btn" id="loginButton">–£–≤—ñ–π—Ç–∏</button>
      <div class="login-error" id="loginError"></div>
    </div>
    <p class="screen-hint">
      –ü–æ—Ä–∞–¥–∞: –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–æ–ª—ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ –Ω–∞ –Ω–æ—É—Ç–±—É—Ü—ñ, –∞ –¥–ª—è —Ä–æ–ª—ñ –µ–∫—Ä–∞–Ω–∞ ‚Äî –Ω–∞ —Ç–µ–ª–µ–≤—ñ–∑–æ—Ä—ñ.
    </p>
  </div>

  <div id="adminView" style="display:none;">
    <div class="app">
      <div class="admin-header">
        <div>
          <div class="admin-header-title">–ö–∞—Ñ–µ ‚Äì –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
          <div class="admin-header-sub" id="statsText"></div>
          <div class="status-legend" id="statusLegend"></div>
          <div class="sync-status" id="syncStatus"></div>
        </div>
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()" style="display:none;">‚ò∞</button>
        <div class="admin-header-right">
          <button class="btn secondary small" id="quickModeBtn" onclick="toggleQuickMode()" title="–®–≤–∏–¥–∫–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è">‚ö° –®–≤–∏–¥–∫–æ</button>
          <button class="btn secondary" onclick="setMode('analytics')">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
          <button class="btn secondary" onclick="openScreenWindow()">–í—ñ–¥–∫—Ä–∏—Ç–∏ –µ–∫—Ä–∞–Ω –Ω–∞ —ñ–Ω—à–æ–º—É –µ–∫—Ä–∞–Ω—ñ</button>
          <button class="btn danger small" onclick="confirmClearAll()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
          <button class="btn small secondary" id="logoutBtn" onclick="logout()">–í–∏–π—Ç–∏</button>
        </div>
      </div>
      <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
      <div class="mobile-menu" id="mobileMenu">
        <button class="mobile-menu-close" onclick="closeMobileMenu()">√ó</button>
        <button class="btn secondary mobile-menu-item" onclick="toggleQuickMode(); closeMobileMenu();">‚ö° –®–≤–∏–¥–∫–æ</button>
        <button class="btn secondary mobile-menu-item" onclick="setMode('analytics'); closeMobileMenu();">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
        <button class="btn secondary mobile-menu-item" onclick="openScreenWindow(); closeMobileMenu();">–í—ñ–¥–∫—Ä–∏—Ç–∏ –µ–∫—Ä–∞–Ω</button>
        <button class="btn danger mobile-menu-item" onclick="confirmClearAll(); closeMobileMenu();">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ</button>
        <button class="btn secondary mobile-menu-item" id="mobileLogoutBtn" onclick="logout(); closeMobileMenu();">–í–∏–π—Ç–∏</button>
      </div>

      <div class="last-order-quick" id="lastOrderQuick">
        <div class="last-order-quick-header">
          <div class="last-order-quick-title">–û—Å—Ç–∞–Ω–Ω—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
          <button class="text-button" onclick="hideLastOrderQuick()">‚úï</button>
        </div>
        <div class="last-order-quick-content" id="lastOrderQuickContent"></div>
        <button class="btn small secondary last-order-quick-btn" onclick="copyLastOrder()">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>

      <div class="admin-form">
        <div class="admin-form-title">–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
        <div class="admin-form-row">
          <label for="orderName">–Ü–º'—è –≥–æ—Å—Ç—è –∞–±–æ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∏–∫–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –∞–ª–µ –±–∞–∂–∞–Ω–æ)</label>
          <input id="orderName" type="text" list="nameSuggestions" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ú–∞—Ä—ñ—è, –°—Ç–æ–ª–∏–∫ 3" autocomplete="off" />
          <datalist id="nameSuggestions"></datalist>
        </div>
        <div class="admin-form-row" id="quickCombosRow" style="display:none;">
          <label>‚≠ê –ü–æ–ø—É–ª—è—Ä–Ω—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó</label>
          <div class="quick-combos" id="quickCombos"></div>
        </div>
        <div class="admin-form-row">
          <label>–ú–µ–Ω—é (–¥–æ–¥–∞–≤–∞–π—Ç–µ –ø–æ–∑–∏—Ü—ñ—ó –≤–µ–ª–∏–∫–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏)</label>
          <div class="menu-builder" id="menuBuilder"></div>
        </div>
        <div class="admin-form-row manual-extra-row">
          <label for="manualItemInput">–ù–µ–º–∞—î –≤ –º–µ–Ω—é? –î–æ–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É</label>
          <div class="manual-extra-controls">
            <input id="manualItemNameInput" type="text" placeholder="–ù–∞–∑–≤–∞ –ø–æ–∑–∏—Ü—ñ—ó" />
            <input id="manualItemPriceInput" type="number" min="0" step="0.01" placeholder="–¶—ñ–Ω–∞, ‚Ç¨" />
            <button class="btn secondary small" type="button" id="manualItemAddBtn">–î–æ–¥–∞—Ç–∏</button>
          </div>
          <div class="manual-extra-list" id="manualExtrasList"></div>
        </div>
        <div class="admin-form-row">
          <label for="orderCustomNote">–ü–æ–±–∞–∂–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –±–µ–∑ —Ü—É–∫—Ä—É, –∑–∞–±—Ä–∞—Ç–∏ –∑ —Å–æ–±–æ—é)</label>
          <input id="orderCustomNote" type="text" placeholder="–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫—É –ø—Ä–∏–º—ñ—Ç–∫—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" />
        </div>
        <div class="admin-form-row">
          <label for="orderItems">–°–∫–ª–∞–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)</label>
          <textarea id="orderItems" rows="3" placeholder="–î–æ–¥–∞–π—Ç–µ –ø–æ–∑–∏—Ü—ñ—ó —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ –≤–∏—â–µ" readonly></textarea>
          <div class="builder-toolbar">
            <button class="btn small secondary" type="button" id="clearBuilderBtn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div class="order-summary">
          <div class="order-summary-items" id="orderSummaryList"></div>
          <div class="order-summary-total">
            <span>–°—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>
            <span id="orderTotalText">0,00¬†‚Ç¨</span>
          </div>
          <div class="payment-row">
            <label for="clientPaidInput">–ö–ª—ñ—î–Ω—Ç –¥–∞–≤</label>
            <input id="clientPaidInput" type="number" min="0" step="0.01" placeholder="0,00" />
          </div>
          <div class="order-finance-info">
            <span>–†–µ—à—Ç–∞</span>
            <strong id="changeDueText">0,00¬†‚Ç¨</strong>
          </div>
        </div>
        <div class="admin-form-footer">
          <div class="hint">
            –ü—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞—î –Ω–æ–º–µ—Ä (1, 2, 3, ...).
          </div>
          <button class="btn" id="addOrderBtn">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>
      </div>

      <div class="search-bar">
        <input id="searchOrdersInput" type="text" placeholder="üîç –ü–æ—à—É–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å (—ñ–º'—è, –Ω–æ–º–µ—Ä, –ø–æ–∑–∏—Ü—ñ—ó)..." />
      </div>
      <div class="quick-actions">
        <button class="quick-action-btn" data-filter="all" onclick="setFilter('all')">–í—Å—ñ</button>
        <button class="quick-action-btn" data-filter="new" onclick="setFilter('new')">–ù–æ–≤—ñ</button>
        <button class="quick-action-btn" data-filter="in_progress" onclick="setFilter('in_progress')">–í —Ä–æ–±–æ—Ç—ñ</button>
        <button class="quick-action-btn" data-filter="ready" onclick="setFilter('ready')">–ì–æ—Ç–æ–≤—ñ</button>
        <button class="quick-action-btn" data-filter="done" onclick="setFilter('done')">–í–∏–¥–∞–Ω—ñ</button>
      </div>
      <div id="adminColumns" class="admin-columns"></div>
    </div>
    <button class="scroll-to-top" id="scrollToTopBtn" onclick="scrollToTop()" title="–î–æ —Ñ–æ—Ä–º–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è">‚Üë</button>
  </div>

  <div id="analyticsView" style="display:none;">
    <div class="app">
      <div class="admin-header">
        <div>
          <div class="admin-header-title">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å</div>
          <div class="admin-header-sub">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ –∞–Ω–∞–ª—ñ–∑ —Ä–æ–±–æ—Ç–∏ –∫–∞—Ñ–µ</div>
        </div>
        <button class="mobile-menu-btn" id="analyticsMobileMenuBtn" onclick="toggleAnalyticsMobileMenu()" style="display:none;">‚ò∞</button>
        <div class="admin-header-right">
          <button class="btn secondary" onclick="setMode('admin')">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å</button>
        </div>
      </div>
      <div class="mobile-menu-overlay" id="analyticsMobileMenuOverlay" onclick="closeAnalyticsMobileMenu()"></div>
      <div class="mobile-menu" id="analyticsMobileMenu">
        <button class="mobile-menu-close" onclick="closeAnalyticsMobileMenu()">√ó</button>
        <button class="btn secondary mobile-menu-item" onclick="setMode('admin'); closeAnalyticsMobileMenu();">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å</button>
        <button class="btn secondary mobile-menu-item" id="analyticsMobileLogoutBtn" onclick="logout(); closeAnalyticsMobileMenu();">–í–∏–π—Ç–∏</button>
      </div>
      <div id="analyticsContent"></div>
    </div>
  </div>

  <div id="screenView" style="display:none;">
    <div class="screen-inner">
      <button class="btn secondary small" id="screenLogoutBtn" onclick="logout()" style="display:none;">–í–∏–π—Ç–∏</button>
      <div class="screen-title">–ì–æ—Ç–æ–≤—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
      <div class="screen-sub">–ë—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–¥—ñ–π–¥—ñ—Ç—å –¥–æ —Å—Ç—ñ–π–∫–∏, –∫–æ–ª–∏ –ø–æ–±–∞—á–∏—Ç–µ —Å–≤—ñ–π –Ω–æ–º–µ—Ä.</div>
      <div class="screen-meta">
        <div id="waitTimeText"></div>
        <div id="inProgressText"></div>
      </div>
      <div id="inProgressSectionTitle" class="inprogress-section-title" style="display:none;">
        –ó–∞—Ä–∞–∑ –≥–æ—Ç—É—î–º–æ:
      </div>
      <div id="inProgressContainer" class="inprogress-grid"></div>
      <div id="readyContainer" class="ready-grid"></div>
      <div id="screenEmpty" class="screen-no-orders" style="display:none;">
        –ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≥–æ—Ç–æ–≤–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å.
      </div>
      <div id="recentDone" class="recent-done"></div>
      <div class="screen-footer">
        –î—è–∫—É—î–º–æ, —â–æ –∑–∞–≤—ñ—Ç–∞–ª–∏. –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≥–æ—Ç—É—î—Ç—å—Å—è –∑ –ª—é–±–æ–≤'—é. <span>üôè</span>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-G0yteWPZMhUlCT3VkOITkkpFmS6r30YIOCwRvDDDeWGPAHDq6cHruM3aMcMBXNPe" crossorigin="anonymous"></script>
  <script>
    const API_BASE = "/api/orders";
    const AUTH_ENDPOINT = "/api/login";
    const AUTH_STORAGE_KEY = "cafeSession_v1";
    const roleLabels = {
      admin: "–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫",
      screen: "–í–µ–ª–∏–∫–∏–π –µ–∫—Ä–∞–Ω"
    };

    const statusConfig = [
      { key: "new", title: "–ù–æ–≤—ñ", color: "#2563eb" },
      { key: "in_progress", title: "–í —Ä–æ–±–æ—Ç—ñ", color: "#f59e0b" },
      { key: "ready", title: "–ì–æ—Ç–æ–≤—ñ (–Ω–∞ –≤–∏–¥–∞—á—É)", color: "#16a34a" },
      { key: "done", title: "–í–∏–¥–∞–Ω—ñ", color: "#6b7280" }
    ];

    const menuConfig = [
      {
        key: "drinks",
        title: "–ù–∞–ø–æ—ó",
        items: [
          { key: "americano", label: "–ê–º–µ—Ä–∏–∫–∞–Ω–æ", price: 1.5 },
          { key: "cappuccino", label: "–ö–∞–ø—É—á–∏–Ω–æ", price: 2 },
          { key: "latteMacchiato", label: "–õ–∞—Ç–µ –º–∞–∫—ñ–∞—Ç–æ", price: 2 },
          { key: "cocoa", label: "–ö–∞–∫–∞–æ", price: 1.5 },
          { key: "greenfieldTea", label: "–ß–∞–π Greenfield", price: 1 },
          { key: "lovareTea", label: "–ß–∞–π Lovare", price: 1 }
        ]
      },
      {
        key: "desserts",
        title: "–î–µ—Å–µ—Ä—Ç–∏",
        items: [
          { key: "macaron", label: "–ú–∞–∫–∞—Ä–æ–Ω", price: 2.5 },
          { key: "cheesecake", label: "–ß–∏–∑–∫–µ–π–∫", price: 2.5 },
          { key: "medovik", label: "–ú–µ–¥–æ–≤–∏–∫", price: 2.5 },
          { key: "napoleon", label: "–ù–∞–ø–æ–ª–µ–æ–Ω", price: 2.5 }
        ]
      },
      {
        key: "waffle",
        title: "–í–∞—Ñ–µ–ª—å–Ω—ñ —Ç–æ—Ä—Ç–∏, –≥–æ—Ä—ñ—à–∫–∏",
        items: [
          { key: "waffleCake", label: "–í–∞—Ñ–µ–ª—å–Ω–∏–π —Ç–æ—Ä—Ç", price: 1 },
          { key: "horishok", label: "–ì–æ—Ä—ñ—à–æ–∫", price: 0.5 }
        ]
      },
      {
        key: "other",
        title: "–†–µ—à—Ç–∞",
        items: [
          { key: "mandarin", label: "–ú–∞–Ω–¥–∞—Ä–∏–Ω", price: 0.5 },
          { key: "croissant", label: "–ö—Ä—É–∞—Å–∞–Ω ü•ê", price: 1 },
          { key: "cake", label: "–ö–µ–∫—Å", price: 1 },
          { key: "cookie", label: "–ü–µ—á–∏–≤–æ", price: 1.5 }
        ]
      }
    ];

    const menuItemIndex = new Map();
    menuConfig.forEach(category => {
      category.items.forEach(item => {
        menuItemIndex.set(item.key, item);
      });
    });

    const DONE_HIDE_WINDOW_MS = 30 * 60 * 1000;
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —á–∞—Å, —è–∫–∏–π –≤—Ä–∞—Ö–æ–≤—É—î–º–æ –≤ —Å–µ—Ä–µ–¥–Ω—å–æ–º—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–æ 90 —Ö–≤)
    const MAX_WAIT_MINUTES_FOR_AVG = 90;
    // –ú–∏ —Ä–∞—Ö—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—ñ–ª—å–∫–∏ –∑ –º–æ–º–µ–Ω—Ç—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –µ–∫—Ä–∞–Ω–∞ –≥–æ—Å—Ç–µ–π,
    // —â–æ–± —Å—Ç–∞—Ä—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –¥–Ω—ñ–≤ –Ω–µ –ø—Å—É–≤–∞–ª–∏ —Å–µ—Ä–µ–¥–Ω—î
    let screenStatsStartTime = null;
    const WAIT_TIME_SAMPLE_SIZE = 6;

    let orders = [];
    let currentMode = "select";
    let authToken = null;
    let authRole = null;
    let selectedRole = null;
    let socket = null;
    let lastSerialized = "";
    let refreshPromise = null;
    const FALLBACK_POLL_INTERVAL_MS = 4000;
    const SOCKET_IDLE_GRACE_MS = 15000;
    let pollTimer = null;
    let inactivityTimer = null;
    let lastRealtimeUpdate = 0;
    let builderState = {};
    let manualExtras = [];
    let manualExtraCounter = 0;
    let hideOldDone = false;
    let pendingReadyHighlights = new Set();
    let readyAudioContext = null;
    let currentOrderTotal = 0;
    let currentFilter = "all";
    let searchQuery = "";
    let lastOrder = null;
    let searchDebounceTimer = null;
    let reconnectTimer = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 10;
    const RECONNECT_BASE_DELAY = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞
    let heartbeatInterval = null;
    const HEARTBEAT_INTERVAL_MS = 30000; // 30 —Å–µ–∫—É–Ω–¥
    let quickMode = false;
    let nameHistory = new Set();
    let favoriteCombos = [];
    let soundEnabled = true;
    let soundVolume = 0.5;

    function setSyncStatus(message, isError = false) {
      const el = document.getElementById("syncStatus");
      if (!el) return;
      el.textContent = message || "";
      el.classList.toggle("error", Boolean(isError));
    }

    function saveSession() {
      try {
        if (!authToken || !authRole) {
          sessionStorage.removeItem(AUTH_STORAGE_KEY);
        } else {
          sessionStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ token: authToken, role: authRole }));
        }
      } catch (err) {
        // ignore
      }
    }

    function loadSession() {
      try {
        const raw = sessionStorage.getItem(AUTH_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && parsed.token && parsed.role) {
          authToken = parsed.token;
          authRole = parsed.role;
        }
      } catch (err) {
        // ignore parse errors
      }
    }

    function renderMenuBuilder() {
      const root = document.getElementById("menuBuilder");
      if (!root) return;
      const html = menuConfig
        .map(category => {
          const itemsHtml = category.items
            .map(item => {
              return (
                '<div class="menu-item-card" data-item="' +
                item.key +
                '">' +
                '<div class="menu-item-title">' +
                item.label +
                "</div>" +
                '<div class="menu-item-price">' +
                formatPriceValue(item.price || 0) +
                "</div>" +
                '<div class="menu-item-controls">' +
                '<button type="button" class="counter-btn" data-action="decrement" data-item="' +
                item.key +
                '">‚àí</button>' +
                '<div class="menu-count" data-count="' +
                item.key +
                '">0</div>' +
                '<button type="button" class="counter-btn" data-action="increment" data-item="' +
                item.key +
                '">+</button>' +
                "</div>" +
                "</div>"
              );
            })
            .join("");
          return (
            '<div class="menu-category" data-category="' +
            category.key +
            '">' +
            '<div class="menu-category-header" onclick="toggleCategory(\'' +
            category.key +
            '\')">' +
            '<div class="menu-category-title">' +
            category.title +
            "</div>" +
            '<div class="menu-category-toggle">‚ñº</div>' +
            "</div>" +
            '<div class="menu-items">' +
            itemsHtml +
            "</div>" +
            "</div>"
          );
        })
        .join("");
      root.innerHTML = html;
    }

    function toggleCategory(categoryKey) {
      const categoryEl = document.querySelector(`[data-category="${categoryKey}"]`);
      if (categoryEl) {
        categoryEl.classList.toggle("collapsed");
      }
    }

    // Scroll to top —Ñ—É–Ω–∫—Ü—ñ—è
    function scrollToTop() {
      const adminForm = document.querySelector(".admin-form");
      if (adminForm) {
        adminForm.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
      closeMobileMenu();
      closeAnalyticsMobileMenu();
    }

    // –ü–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ scroll to top
    function handleScroll() {
      const scrollBtn = document.getElementById("scrollToTopBtn");
      if (!scrollBtn) return;
      // –ü–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –≤ admin view
      if (currentMode !== "admin") {
        scrollBtn.classList.remove("visible");
        return;
      }
      const scrollY = window.scrollY || document.documentElement.scrollTop;
      if (scrollY > 300) {
        scrollBtn.classList.add("visible");
      } else {
        scrollBtn.classList.remove("visible");
      }
    }

    // –ú–æ–±—ñ–ª—å–Ω–µ –º–µ–Ω—é
    function toggleMobileMenu() {
      const menu = document.getElementById("mobileMenu");
      const overlay = document.getElementById("mobileMenuOverlay");
      if (menu && overlay) {
        menu.classList.toggle("open");
        overlay.classList.toggle("show");
      }
    }

    function closeMobileMenu() {
      const menu = document.getElementById("mobileMenu");
      const overlay = document.getElementById("mobileMenuOverlay");
      if (menu && overlay) {
        menu.classList.remove("open");
        overlay.classList.remove("show");
      }
    }

    // –ú–æ–±—ñ–ª—å–Ω–µ –º–µ–Ω—é –¥–ª—è analytics view
    function toggleAnalyticsMobileMenu() {
      const menu = document.getElementById("analyticsMobileMenu");
      const overlay = document.getElementById("analyticsMobileMenuOverlay");
      if (menu && overlay) {
        menu.classList.toggle("open");
        overlay.classList.toggle("show");
      }
    }

    function closeAnalyticsMobileMenu() {
      const menu = document.getElementById("analyticsMobileMenu");
      const overlay = document.getElementById("analyticsMobileMenuOverlay");
      if (menu && overlay) {
        menu.classList.remove("open");
        overlay.classList.remove("show");
      }
    }

    // –ü–æ–∫–∞–∑ –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–µ–Ω—é –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
    function updateMobileMenuVisibility() {
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const analyticsMobileMenuBtn = document.getElementById("analyticsMobileMenuBtn");
      
      // –ü–æ–∫–∞–∑—É—î–º–æ –≤ admin view
      if (mobileMenuBtn) {
      if (currentMode === "admin" && window.innerWidth <= 640) {
        mobileMenuBtn.style.display = "block";
      } else {
        mobileMenuBtn.style.display = "none";
        closeMobileMenu();
        }
      }
      
      // –ü–æ–∫–∞–∑—É—î–º–æ –≤ analytics view
      if (analyticsMobileMenuBtn) {
        if (currentMode === "analytics" && window.innerWidth <= 640) {
          analyticsMobileMenuBtn.style.display = "block";
        } else {
          analyticsMobileMenuBtn.style.display = "none";
          closeAnalyticsMobileMenu();
        }
      }
    }

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–∏–±—Ä–∞–Ω—ñ —Å–º–∞–∫–∏ –¥–ª—è —á–∞—é Lovare
    const builderStateFlavors = {};

    function adjustItemCount(itemKey, delta) {
      if (!menuItemIndex.has(itemKey)) return;
      
      // –Ø–∫—â–æ –¥–æ–¥–∞—î–º–æ —á–∞–π Lovare, –ø–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–∏–±–æ—Ä—É —Å–º–∞–∫—É
      if (itemKey === "lovareTea" && delta > 0) {
        showFlavorModal(itemKey);
        return;
      }
      
      // –Ø–∫—â–æ –∑–º–µ–Ω—à—É—î–º–æ —á–∞–π Lovare, –≤–∏–¥–∞–ª—è—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Å–º–∞–∫
      if (itemKey === "lovareTea" && delta < 0) {
        const currentCount = builderState[itemKey] || 0;
        if (currentCount > 0) {
          builderState[itemKey] = currentCount - 1;
          if (builderStateFlavors[itemKey] && builderStateFlavors[itemKey].length > 0) {
            builderStateFlavors[itemKey].pop();
            if (builderStateFlavors[itemKey].length === 0) {
              delete builderStateFlavors[itemKey];
            }
          }
          if (builderState[itemKey] === 0) {
            delete builderState[itemKey];
            delete builderStateFlavors[itemKey];
          }
        }
        updateOrderPreview();
        return;
      }
      
      const next = Math.max(0, (builderState[itemKey] || 0) + delta);
      if (next === 0) {
        delete builderState[itemKey];
        delete builderStateFlavors[itemKey];
      } else {
        builderState[itemKey] = next;
      }
      updateOrderPreview();
    }

    let pendingFlavorItemKey = null;

    function showFlavorModal(itemKey) {
      pendingFlavorItemKey = itemKey;
      const overlay = document.getElementById("flavorModalOverlay");
      if (overlay) {
        overlay.classList.add("show");
        // –°–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä
        document.querySelectorAll(".flavor-option").forEach(opt => {
          opt.classList.remove("selected");
        });
      }
    }

    function closeFlavorModal() {
      const overlay = document.getElementById("flavorModalOverlay");
      if (overlay) {
        overlay.classList.remove("show");
      }
      pendingFlavorItemKey = null;
    }

    function selectFlavor(flavor) {
      if (!pendingFlavorItemKey) return;
      
      // –í—ñ–∑—É–∞–ª—å–Ω–∏–π —Ñ—ñ–¥–±–µ–∫ - –≤–∏–¥—ñ–ª—è—î–º–æ –≤–∏–±—Ä–∞–Ω–∏–π —Å–º–∞–∫
      document.querySelectorAll(".flavor-option").forEach(opt => {
        opt.classList.remove("selected");
        if (opt.getAttribute("data-flavor") === flavor) {
          opt.classList.add("selected");
        }
      });
      
      // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ —Ñ—ñ–¥–±–µ–∫—É –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä–∏—Ç—Ç—è–º
      setTimeout(() => {
        const itemKey = pendingFlavorItemKey;
        const currentCount = builderState[itemKey] || 0;
        builderState[itemKey] = currentCount + 1;
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–º–∞–∫ –¥–ª—è —Ü—å–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞
        if (!builderStateFlavors[itemKey]) {
          builderStateFlavors[itemKey] = [];
        }
        builderStateFlavors[itemKey].push(flavor);
        
        closeFlavorModal();
        updateOrderPreview();
      }, 150);
    }

    function updateMenuCounters() {
      document.querySelectorAll("[data-count]").forEach(el => {
        const key = el.getAttribute("data-count");
        if (!key) return;
        el.textContent = builderState[key] || 0;
      });
    }

    function renderManualExtras() {
      const root = document.getElementById("manualExtrasList");
      if (!root) return;
      if (!manualExtras.length) {
        root.innerHTML = '<div class="hint">–°—é–¥–∏ –¥–æ–¥–∞—Å—Ç—å—Å—è –≤—Å–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ.</div>';
        return;
      }
      root.innerHTML = manualExtras
        .map(extra => {
          return (
            '<div class="manual-extra-chip">' +
            '<div class="manual-chip-top">' +
            "<span>" +
            escapeHtml(extra.label) +
            "</span>" +
            "<span>" +
            formatPriceValue(extra.unitPrice) +
            "</span>" +
            "</div>" +
            '<div class="manual-chip-controls">' +
            '<div class="menu-item-controls">' +
            '<button type="button" class="counter-btn" data-manual-action="decrement" data-manual-id="' +
            extra.id +
            '">‚àí</button>' +
            '<div class="menu-count" data-manual-count="' +
            extra.id +
            '">' +
            extra.quantity +
            "</div>" +
            '<button type="button" class="counter-btn" data-manual-action="increment" data-manual-id="' +
            extra.id +
            '">+</button>' +
            "</div>" +
            '<button type="button" class="manual-chip-remove" data-manual-action="remove" data-manual-id="' +
            extra.id +
            '">–ü—Ä–∏–±—Ä–∞—Ç–∏</button>' +
            "</div>" +
            "</div>"
          );
        })
        .join("");
    }

    function getStructuredItems() {
      const items = [];
      menuConfig.forEach(category => {
        category.items.forEach(item => {
          const quantity = builderState[item.key] || 0;
          if (quantity > 0) {
            // –î–ª—è —á–∞—é Lovare —Å—Ç–≤–æ—Ä—é—î–º–æ –æ–∫—Ä–µ–º—ñ –ø–æ–∑–∏—Ü—ñ—ó –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å–º–∞–∫—É
            if (item.key === "lovareTea" && builderStateFlavors[item.key]) {
              const flavors = builderStateFlavors[item.key];
              // –ì—Ä—É–ø—É—î–º–æ —Å–º–∞–∫–∏ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é
              const flavorCounts = {};
              flavors.forEach(flavor => {
                flavorCounts[flavor] = (flavorCounts[flavor] || 0) + 1;
              });
              // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–∫—Ä–µ–º—É –ø–æ–∑–∏—Ü—ñ—é –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å–º–∞–∫—É
              Object.keys(flavorCounts).forEach(flavor => {
                items.push({
                  key: item.key + "_" + flavor,
                  label: item.label + " (" + flavor + ")",
                  unitPrice: item.price || 0,
                  quantity: flavorCounts[flavor]
                });
              });
            } else {
              items.push({
                key: item.key,
                label: item.label,
                unitPrice: item.price || 0,
                quantity
              });
            }
          }
        });
      });
      manualExtras.forEach(extra => {
        if (extra.quantity > 0) {
          items.push({
            key: extra.id,
            label: extra.label,
            unitPrice: extra.unitPrice,
            quantity: extra.quantity,
            isManual: true
          });
        }
      });
      return items;
    }

    function calculateOrderTotal(items) {
      return items.reduce((sum, item) => sum + item.unitPrice * item.quantity, 0);
    }

    function buildOrderItemsText(structuredItems) {
      const items = structuredItems || getStructuredItems();
      const lines = items.map(
        item => item.label + " √ó" + item.quantity + " ‚Äî " + formatPriceValue(item.unitPrice * item.quantity)
      );
      const noteEl = document.getElementById("orderCustomNote");
      const note = noteEl ? noteEl.value.trim() : "";
      if (note) {
        lines.push("–ü–æ–±–∞–∂–∞–Ω–Ω—è: " + note);
      }
      return lines.join("\n");
    }

    function updateOrderSummary() {
      const structuredItems = getStructuredItems();
      const listEl = document.getElementById("orderSummaryList");
      const totalEl = document.getElementById("orderTotalText");
      const changeEl = document.getElementById("changeDueText");
      const clientPaidInput = document.getElementById("clientPaidInput");
      if (listEl) {
        if (!structuredItems.length) {
          listEl.innerHTML = '<div class="hint">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π.</div>';
        } else {
          listEl.innerHTML = structuredItems
            .map(item => {
              return (
                '<div class="order-summary-row">' +
                "<span>" +
                escapeHtml(item.label) +
                " √ó" +
                item.quantity +
                "</span>" +
                "<strong>" +
                formatPriceValue(item.unitPrice * item.quantity) +
                "</strong>" +
                "</div>"
              );
            })
            .join("");
        }
      }
      const total = calculateOrderTotal(structuredItems);
      currentOrderTotal = total;
      if (totalEl) {
        totalEl.textContent = formatPriceValue(total);
      }
      let clientPaidValue = null;
      if (clientPaidInput) {
        clientPaidValue = parseMoneyInput(clientPaidInput.value);
      }
      const change = clientPaidValue !== null ? Math.max(0, clientPaidValue - total) : 0;
      if (changeEl) {
        changeEl.textContent = formatPriceValue(change);
      }
      return { items: structuredItems, total, clientPaidValue, change };
    }

    function updateOrderPreview() {
      const summary = updateOrderSummary();
      const itemsText = buildOrderItemsText(summary.items);
      const target = document.getElementById("orderItems");
      if (target) {
        target.value = itemsText;
      }
      updateMenuCounters();
    }

    function clearOrderDraft() {
      builderState = {};
      Object.keys(builderStateFlavors).forEach(key => delete builderStateFlavors[key]);
      manualExtras = [];
      currentOrderTotal = 0;
      const noteEl = document.getElementById("orderCustomNote");
      if (noteEl) {
        noteEl.value = "";
      }
      const manualNameInput = document.getElementById("manualItemNameInput");
      if (manualNameInput) {
        manualNameInput.value = "";
      }
      const manualPriceInput = document.getElementById("manualItemPriceInput");
      if (manualPriceInput) {
        manualPriceInput.value = "";
      }
      const clientPaidInput = document.getElementById("clientPaidInput");
      if (clientPaidInput) {
        clientPaidInput.value = "";
      }
      updateOrderPreview();
      renderManualExtras();
    }

    function addManualExtraFromInput() {
      const nameInput = document.getElementById("manualItemNameInput");
      const priceInput = document.getElementById("manualItemPriceInput");
      if (!nameInput || !priceInput) return;
      const name = nameInput.value.trim();
      const price = parseMoneyInput(priceInput.value);
      if (!name) {
        alert("–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É –ø–æ–∑–∏—Ü—ñ—ó.");
        return;
      }
      if (price === null) {
        alert("–í–∫–∞–∂—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Ü—ñ–Ω—É.");
        return;
      }
      manualExtraCounter += 1;
      manualExtras.push({
        id: "manual_" + manualExtraCounter,
        label: name,
        unitPrice: price,
        quantity: 1
      });
      nameInput.value = "";
      priceInput.value = "";
      updateOrderPreview();
      renderManualExtras();
    }

    function adjustManualExtra(manualId, delta) {
      const extra = manualExtras.find(item => item.id === manualId);
      if (!extra) return;
      const next = extra.quantity + delta;
      if (next <= 0) {
        manualExtras = manualExtras.filter(item => item.id !== manualId);
      } else {
        extra.quantity = next;
      }
      updateOrderPreview();
      renderManualExtras();
    }

    function removeManualExtra(manualId) {
      manualExtras = manualExtras.filter(item => item.id !== manualId);
      updateOrderPreview();
      renderManualExtras();
    }

    function renderStatusLegend() {
      const legend = document.getElementById("statusLegend");
      if (!legend) return;
      legend.innerHTML =
        "<strong>–ù–æ–≤—ñ</strong> ‚Äì —Ç—ñ–ª—å–∫–∏ —â–æ –ø—Ä–∏–π–Ω—è—Ç—ñ. " +
        "<strong>–í —Ä–æ–±–æ—Ç—ñ</strong> ‚Äì –≥–æ—Ç—É—î–º–æ. " +
        "<strong>–ì–æ—Ç–æ–≤—ñ</strong> ‚Äì —á–µ–∫–∞—é—Ç—å –≥–æ—Å—Ç—è. " +
        "<strong>–í–∏–¥–∞–Ω—ñ</strong> ‚Äì –≥—ñ—Å—Ç—å –∑–∞–±—Ä–∞–≤.";
    }

    function getDoneReferenceTimestamp(order) {
      return order.doneAt || order.readyAt || order.inProgressAt || order.createdAt || 0;
    }

    function calculateAverageWaitMinutes() {
      const now = Date.now();
      const todayStart = new Date();
      todayStart.setHours(0, 0, 0, 0);
      const todayStartMs = todayStart.getTime();
      const maxWaitMs = MAX_WAIT_MINUTES_FOR_AVG * 60 * 1000;

      // –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –¥–∞–Ω—ñ –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å–µ–∞–Ω—Å—É (—è–∫—â–æ –µ–∫—Ä–∞–Ω –±—É–≤ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π)
      let sample = [];
      if (screenStatsStartTime) {
        sample = orders
          .filter(o => o.readyAt && o.createdAt && o.status === "done")
          .filter(o => {
            const created = o.createdAt || 0;
            const ready = o.readyAt || 0;
            if (!created || !ready) return false;
            // –¢—ñ–ª—å–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, —è–∫—ñ —Å—Ç–∞–ª–∏ –≥–æ—Ç–æ–≤—ñ –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –µ–∫—Ä–∞–Ω–∞
            if (ready < screenStatsStartTime) return false;
            const wait = Math.max(0, ready - created);
            if (!wait || wait > maxWaitMs) return false;
            return true;
          })
          .sort((a, b) => (b.readyAt || 0) - (a.readyAt || 0))
          .slice(0, WAIT_TIME_SAMPLE_SIZE);
      }

      // –Ø–∫—â–æ –Ω–µ–º–∞—î –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å–µ–∞–Ω—Å—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–∞–Ω—ñ –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
      if (sample.length < 3) {
        sample = orders
          .filter(o => o.readyAt && o.createdAt && o.status === "done")
          .filter(o => {
            const created = o.createdAt || 0;
            const ready = o.readyAt || 0;
            if (!created || !ready) return false;
            // –¢—ñ–ª—å–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
            if (ready < todayStartMs) return false;
            const wait = Math.max(0, ready - created);
            // —ñ–≥–Ω–æ—Ä—É—î–º–æ –∞–Ω–æ–º–∞–ª—å–Ω–æ –≤–µ–ª–∏–∫—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
            if (!wait || wait > maxWaitMs) return false;
            return true;
          })
          .sort((a, b) => (b.readyAt || 0) - (a.readyAt || 0))
          .slice(0, WAIT_TIME_SAMPLE_SIZE);
      }

      // –Ø–∫—â–æ –≤—Å–µ —â–µ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ –≥–æ—Ç–æ–≤—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–Ω–µ —Å—Ç–∞—Ä—à—ñ –∑–∞ 24 –≥–æ–¥–∏–Ω–∏)
      if (sample.length < 2) {
        const dayAgo = now - 24 * 60 * 60 * 1000;
        sample = orders
          .filter(o => o.readyAt && o.createdAt && o.status === "done")
          .filter(o => {
            const created = o.createdAt || 0;
            const ready = o.readyAt || 0;
            if (!created || !ready) return false;
            // –¢—ñ–ª—å–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 24 –≥–æ–¥–∏–Ω–∏
            if (ready < dayAgo) return false;
            const wait = Math.max(0, ready - created);
            if (!wait || wait > maxWaitMs) return false;
            return true;
          })
          .sort((a, b) => (b.readyAt || 0) - (a.readyAt || 0))
          .slice(0, WAIT_TIME_SAMPLE_SIZE);
      }

      if (!sample.length) {
        return null;
      }

      const avgMs =
        sample.reduce((sum, item) => sum + Math.max(0, item.readyAt - item.createdAt), 0) /
        sample.length;
      return Math.max(1, Math.round(avgMs / 60000));
    }

    function describeInProgressOrders() {
      const numbers = orders
        .filter(o => o.status === "in_progress")
        .map(o => o.number)
        .filter(n => n != null)
        .sort((a, b) => a - b);
      if (!numbers.length) {
        return "–ó–∞—Ä–∞–∑ –≥–æ—Ç—É—î–º–æ: –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å";
      }
      return "–ó–∞—Ä–∞–∑ –≥–æ—Ç—É—î–º–æ: ‚Ññ" + numbers.join(", ‚Ññ");
    }

    function handleFreshReadyOrders(ids) {
      pendingReadyHighlights = new Set(ids);
      playReadySound();
    }

    function playReadySound() {
      if (!soundEnabled) return;
      try {
        const AudioContextConstructor = window.AudioContext || window.webkitAudioContext;
        if (!AudioContextConstructor) return;
        if (!readyAudioContext) {
          readyAudioContext = new AudioContextConstructor();
        }
        if (readyAudioContext.state === "suspended") {
          readyAudioContext.resume();
        }
        const ctx = readyAudioContext;
        const now = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(920, now);
        gain.gain.setValueAtTime(0.0008 * soundVolume, now);
        gain.gain.exponentialRampToValueAtTime(0.00001, now + 0.35);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(now);
        osc.stop(now + 0.35);
      } catch (err) {
        // ignore audio errors
      }
    }

    function playNewOrderSound() {
      if (!soundEnabled) return;
      try {
        const AudioContextConstructor = window.AudioContext || window.webkitAudioContext;
        if (!AudioContextConstructor) return;
        if (!readyAudioContext) {
          readyAudioContext = new AudioContextConstructor();
        }
        if (readyAudioContext.state === "suspended") {
          readyAudioContext.resume();
        }
        const ctx = readyAudioContext;
        const now = ctx.currentTime;
        // –Ü–Ω—à–∏–π –∑–≤—É–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–≤–∏—â–∏–π —Ç–æ–Ω, –∫–æ—Ä–æ—Ç—à–∏–π)
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0.001 * soundVolume, now);
        gain.gain.exponentialRampToValueAtTime(0.00001, now + 0.2);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(now);
        osc.stop(now + 0.2);
      } catch (err) {
        // ignore audio errors
      }
    }

    // –®–≤–∏–¥–∫—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function analyzePopularCombinations() {
      const doneOrders = orders.filter(o => o.status === "done" && Array.isArray(o.items) && o.items.length >= 2);
      
      if (doneOrders.length === 0) {
        // –Ø–∫—â–æ –Ω–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–∏—Å–æ–∫
        return [];
      }

      // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –∑ 2-3 –ø–æ–∑–∏—Ü—ñ–π
      const comboCounts = new Map();
      
      doneOrders.forEach(order => {
        const items = order.items.filter(item => item.key && !item.isManual);
        if (items.length < 2) return;

        // –ì–µ–Ω–µ—Ä—É—î–º–æ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –∑ 2 –ø–æ–∑–∏—Ü—ñ–π
        for (let i = 0; i < items.length; i++) {
          for (let j = i + 1; j < items.length; j++) {
            const combo = [
              { key: items[i].key, qty: items[i].quantity || 1 },
              { key: items[j].key, qty: items[j].quantity || 1 }
            ].sort((a, b) => a.key.localeCompare(b.key)); // –°–æ—Ä—Ç—É—î–º–æ –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ

            const comboKey = JSON.stringify(combo);
            const current = comboCounts.get(comboKey) || { combo, count: 0 };
            current.count += 1;
            comboCounts.set(comboKey, current);
          }
        }

        // –¢–∞–∫–æ–∂ –¥–æ–¥–∞—î–º–æ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –∑ 3 –ø–æ–∑–∏—Ü—ñ–π (—è–∫—â–æ —î)
        if (items.length >= 3) {
          for (let i = 0; i < items.length - 2; i++) {
            for (let j = i + 1; j < items.length - 1; j++) {
              for (let k = j + 1; k < items.length; k++) {
                const combo = [
                  { key: items[i].key, qty: items[i].quantity || 1 },
                  { key: items[j].key, qty: items[j].quantity || 1 },
                  { key: items[k].key, qty: items[k].quantity || 1 }
                ].sort((a, b) => a.key.localeCompare(b.key));

                const comboKey = JSON.stringify(combo);
                const current = comboCounts.get(comboKey) || { combo, count: 0 };
                current.count += 1;
                comboCounts.set(comboKey, current);
              }
            }
          }
        }
      });

      // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—é —ñ –±–µ—Ä–µ–º–æ —Ç–æ–ø-6
      const popularCombos = Array.from(comboCounts.values())
        .sort((a, b) => b.count - a.count)
        .slice(0, 6)
        .map(item => {
          // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞–∑–≤—É –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó
          const labels = item.combo.map(comboItem => {
            const menuItem = menuItemIndex.get(comboItem.key);
            const label = menuItem ? menuItem.label : comboItem.key;
            const qty = comboItem.qty > 1 ? ` √ó${comboItem.qty}` : "";
            return label + qty;
          });
          const name = labels.join(" + ");

          return {
            name: name,
            items: item.combo,
            count: item.count
          };
        });

      return popularCombos;
    }

    function loadFavoriteCombos() {
      try {
        // –ê–Ω–∞–ª—ñ–∑—É—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –≥–µ–Ω–µ—Ä—É—î–º–æ –ø–æ–ø—É–ª—è—Ä–Ω—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó
        favoriteCombos = analyzePopularCombinations();
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ localStorage –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
        saveFavoriteCombos();
      } catch (err) {
        console.error("Failed to load favorite combos:", err);
        favoriteCombos = [];
      }
    }

    function updateFavoriteCombos() {
      // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø—É–ª—è—Ä–Ω—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å
      favoriteCombos = analyzePopularCombinations();
      saveFavoriteCombos();
      renderQuickCombos();
    }

    function saveFavoriteCombos() {
      try {
        localStorage.setItem("cafeFavoriteCombos", JSON.stringify(favoriteCombos));
      } catch (err) {
        console.error("Failed to save favorite combos:", err);
      }
    }

    function renderQuickCombos() {
      const container = document.getElementById("quickCombos");
      if (!container) return;
      
      if (!favoriteCombos.length) {
        container.innerHTML = '<div class="hint">–ü–æ–∫–∏ –Ω–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∫–æ–º–±—ñ–Ω–∞—Ü—ñ–π</div>';
        return;
      }

      container.innerHTML = favoriteCombos.map((combo, idx) => {
        return `<button class="quick-combo-btn" onclick="applyQuickCombo(${idx})">${escapeHtml(combo.name)}</button>`;
      }).join("");
    }

    function applyQuickCombo(index) {
      const combo = favoriteCombos[index];
      if (!combo) return;

      builderState = {};
      manualExtras = [];
      
      combo.items.forEach(item => {
        if (menuItemIndex.has(item.key)) {
          builderState[item.key] = item.qty || 1;
        }
      });

      updateOrderPreview();
      renderManualExtras();
      
      // –í—ñ–±—Ä–æ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —ñ–º–µ–Ω
    function updateNameSuggestions() {
      const datalist = document.getElementById("nameSuggestions");
      if (!datalist) return;

      const names = Array.from(nameHistory).filter(n => n && n.trim());
      datalist.innerHTML = names.map(name => 
        `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`
      ).join("");
    }

    function addToNameHistory(name) {
      if (!name || !name.trim()) return;
      nameHistory.add(name.trim());
      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ localStorage
      try {
        const names = Array.from(nameHistory);
        localStorage.setItem("cafeNameHistory", JSON.stringify(names.slice(-50))); // –û—Å—Ç–∞–Ω–Ω—ñ 50
        nameHistory = new Set(names.slice(-50));
      } catch (err) {
        console.error("Failed to save name history:", err);
      }
      updateNameSuggestions();
    }

    function loadNameHistory() {
      try {
        const saved = localStorage.getItem("cafeNameHistory");
        if (saved) {
          const names = JSON.parse(saved);
          nameHistory = new Set(names);
        }
        // –¢–∞–∫–æ–∂ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑ —ñ—Å–Ω—É—é—á–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å
        orders.forEach(order => {
          if (order.name && order.name.trim()) {
            nameHistory.add(order.name.trim());
          }
        });
        updateNameSuggestions();
      } catch (err) {
        console.error("Failed to load name history:", err);
      }
    }

    // –†–µ–∂–∏–º —à–≤–∏–¥–∫–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    function toggleQuickMode() {
      quickMode = !quickMode;
      const btn = document.getElementById("quickModeBtn");
      const form = document.querySelector(".admin-form");
      
      if (btn) {
        btn.classList.toggle("active", quickMode);
        btn.textContent = quickMode ? "‚ö° –®–≤–∏–¥–∫–æ" : "‚ö° –®–≤–∏–¥–∫–æ";
      }

      if (form) {
        form.classList.toggle("quick-mode-active", quickMode);
      }

      // –ü–æ–∫–∞–∑—É—î–º–æ/—Ö–æ–≤–∞—î–º–æ —à–≤–∏–¥–∫—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó
      const combosRow = document.getElementById("quickCombosRow");
      if (combosRow) {
        combosRow.style.display = quickMode ? "flex" : "none";
      }

      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      try {
        localStorage.setItem("cafeQuickMode", JSON.stringify(quickMode));
      } catch (err) {
        console.error("Failed to save quick mode:", err);
      }
    }

    function loadQuickMode() {
      try {
        const saved = localStorage.getItem("cafeQuickMode");
        if (saved) {
          quickMode = JSON.parse(saved);
          if (quickMode) {
            toggleQuickMode(); // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
          }
        }
      } catch (err) {
        console.error("Failed to load quick mode:", err);
      }
    }

    function toggleHideOldDone() {
      hideOldDone = !hideOldDone;
      renderAdminView();
    }

    function startPolling(reason) {
      if (pollTimer) return;
      if (reason) {
        console.debug("[poll] start fallback:", reason);
      }
      pollTimer = setInterval(() => {
        if (authToken) {
          refreshOrders();
        }
      }, FALLBACK_POLL_INTERVAL_MS);
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    function clearInactivityCheck() {
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
        inactivityTimer = null;
      }
    }

    function scheduleInactivityCheck() {
      clearInactivityCheck();
      if (!socket || !socket.connected) {
        return;
      }
      inactivityTimer = setTimeout(() => {
        if (!socket || !socket.connected) {
          startPolling("socket disconnected");
          return;
        }
        const idleFor = Date.now() - lastRealtimeUpdate;
        if (idleFor >= SOCKET_IDLE_GRACE_MS) {
          startPolling("no realtime updates");
        } else {
          scheduleInactivityCheck();
        }
      }, SOCKET_IDLE_GRACE_MS);
    }

    function touchRealtimeUpdate() {
      if (!authToken) return;
      lastRealtimeUpdate = Date.now();
      if (socket && socket.connected && pollTimer) {
        stopPolling();
      }
      scheduleInactivityCheck();
    }

    // –û—Ñ–ª–∞–π–Ω —á–µ—Ä–≥–∞ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å
    let offlineQueue = [];
    const OFFLINE_QUEUE_KEY = "cafeOfflineQueue";

    function loadOfflineQueue() {
      try {
        const saved = localStorage.getItem(OFFLINE_QUEUE_KEY);
        if (saved) {
          offlineQueue = JSON.parse(saved);
        }
      } catch (err) {
        console.error("Failed to load offline queue:", err);
        offlineQueue = [];
      }
    }

    function saveOfflineQueue() {
      try {
        localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(offlineQueue));
      } catch (err) {
        console.error("Failed to save offline queue:", err);
      }
    }

    async function syncOfflineQueue() {
      if (!navigator.onLine || !authToken) return;
      if (offlineQueue.length === 0) return;

      setSyncStatus("–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –æ—Ñ–ª–∞–π–Ω –∑–∞–º–æ–≤–ª–µ–Ω—å...", false);
      const toSync = [...offlineQueue];
      offlineQueue = [];

      for (const order of toSync) {
        try {
          await apiRequest(API_BASE, { method: "POST", body: order });
        } catch (err) {
          // –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤ —á–µ—Ä–≥—É
          offlineQueue.push(order);
          console.error("Failed to sync offline order:", err);
        }
      }

      saveOfflineQueue();
      if (offlineQueue.length === 0) {
        setSyncStatus("–í—Å—ñ –æ—Ñ–ª–∞–π–Ω –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ", false);
      } else {
        setSyncStatus(`–ó–∞–ª–∏—à–∏–ª–æ—Å—å ${offlineQueue.length} –æ—Ñ–ª–∞–π–Ω –∑–∞–º–æ–≤–ª–µ–Ω—å`, true);
      }
    }

    async function apiRequest(path, { method = "GET", body } = {}) {
      const options = { method, headers: {}, cache: "no-store" };
      if (authToken) {
        options.headers["Authorization"] = "Bearer " + authToken;
      }
      if (body !== undefined) {
        options.body = JSON.stringify(body);
        options.headers["Content-Type"] = "application/json";
      }
      options.headers["Cache-Control"] = "no-store";

      try {
      const response = await fetch(path, options);
      let payload = null;
      try {
        if (response.status !== 204) {
          payload = await response.json();
        }
      } catch (err) {
        // ignore parse errors
      }

      if (!response.ok) {
        const message = payload && payload.error ? payload.error : "–ù–µ–º–∞—î –∑–≤'—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.";
        if (response.status === 401) {
          logout(false);
          showLogin();
        }
        throw new Error(message);
      }

      return payload;
      } catch (err) {
        // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ —Ç–∞ —Ü–µ POST –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –æ—Ñ–ª–∞–π–Ω —á–µ—Ä–≥—É
        if (!navigator.onLine && method === "POST" && path === API_BASE && body) {
          offlineQueue.push(body);
          saveOfflineQueue();
          setSyncStatus(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ –æ—Ñ–ª–∞–π–Ω (${offlineQueue.length} –≤ —á–µ—Ä–∑—ñ)`, false);
          // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω—É –∫–æ–ø—ñ—é –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          return {
            id: `offline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...body,
            status: "new",
            createdAt: Date.now(),
            offline: true
          };
        }
        throw err;
      }
    }

    async function duplicateOrder(orderId) {
      const original = orders.find(o => o.id === orderId);
      if (!original) {
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
        return;
      }
      const suggestedName = original.name || "";
      const newName = prompt("–Ø–∫ –ø—ñ–¥–ø–∏—Å–∞—Ç–∏ –Ω–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?", suggestedName);
      if (newName === null) {
        return;
      }
      try {
        const body = {
          name: newName.trim(),
          itemsText: original.itemsText || "",
          items: Array.isArray(original.items) ? original.items : undefined,
          totalPrice: typeof original.totalPrice === "number" ? original.totalPrice : undefined,
          clientPaid: typeof original.clientPaid === "number" ? original.clientPaid : undefined,
          changeDue: typeof original.changeDue === "number" ? original.changeDue : undefined,
          note: original.note || ""
        };
        Object.keys(body).forEach(key => {
          if (body[key] === undefined || body[key] === null || body[key] === "") {
            delete body[key];
          }
        });
        await apiRequest(API_BASE, {
          method: "POST",
          body
        });
        await refreshOrders(true);
      } catch (err) {
        alert(err.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return "";
      const d = new Date(timestamp);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return hh + ":" + mm;
    }

    const currencyFormatter = new Intl.NumberFormat("uk-UA", {
      style: "currency",
      currency: "EUR",
      minimumFractionDigits: 2
    });

    function formatPriceValue(value) {
      const number = typeof value === "number" && Number.isFinite(value) ? value : 0;
      return currencyFormatter.format(Math.round(number * 100) / 100);
    }

    function parseMoneyInput(value) {
      if (value === undefined || value === null || value === "") {
        return null;
      }
      const normalized = String(value).replace(",", ".").trim();
      const parsed = Number.parseFloat(normalized);
      if (Number.isNaN(parsed) || parsed < 0) {
        return null;
      }
      return Math.round(parsed * 100) / 100;
    }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function selectRole(role) {
      selectedRole = role;
      const info = document.getElementById("selectedRoleInfo");
      const form = document.getElementById("loginForm");
      if (info) {
        info.style.display = "block";
        document.getElementById("selectedRoleText").textContent = roleLabels[role] || role;
      }
      form.classList.add("active");
      document.getElementById("loginError").textContent = "";
      const passwordInput = document.getElementById("passwordInput");
      passwordInput.value = "";
      passwordInput.focus();
    }

    function showLogin() {
      currentMode = "select";
      selectedRole = null;
      const loginView = document.getElementById("loginView");
      const adminView = document.getElementById("adminView");
      const screenView = document.getElementById("screenView");
      loginView.style.display = "flex";
      adminView.style.display = "none";
      screenView.style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("screenLogoutBtn").style.display = "none";
      const info = document.getElementById("selectedRoleInfo");
      if (info) {
        info.style.display = "none";
      }
      const form = document.getElementById("loginForm");
      form.classList.remove("active");
      document.getElementById("passwordInput").value = "";
      document.getElementById("loginError").textContent = "";
      setSyncStatus("");
    }

    async function submitLogin() {
      const passwordInput = document.getElementById("passwordInput");
      const loginError = document.getElementById("loginError");
      if (!selectedRole) {
        loginError.textContent = "–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å —Ä–æ–ª—å.";
        return;
      }
      const password = passwordInput.value.trim();
      if (!password) {
        loginError.textContent = "–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å.";
        return;
      }
      loginError.textContent = "";
      try {
        const data = await apiRequest(AUTH_ENDPOINT, {
          method: "POST",
          body: { role: selectedRole, password }
        });
        authToken = data.token;
        authRole = data.role;
        saveSession();
        selectedRole = null;
        passwordInput.value = "";
        await startSession(authRole);
      } catch (err) {
        loginError.textContent = err.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è —É–≤—ñ–π—Ç–∏.";
      }
    }

    async function startSession(preferredMode) {
      if (!authToken || !authRole) {
        showLogin();
        if (preferredMode) {
          selectRole(preferredMode);
        }
        return;
      }

      let mode = preferredMode || (location.hash === "#screen" ? "screen" : "admin");
      if (mode === "screen" && authRole !== "screen") {
        showLogin();
        selectRole("screen");
        return;
      }
      if (mode === "admin" && authRole !== "admin") {
        showLogin();
        selectRole("admin");
        return;
      }

      setMode(mode, true);
      await refreshOrders(true);
      connectSocket(true);
    }

    function logout(showLoginView = true) {
      authToken = null;
      authRole = null;
      if (socket) {
        socket.removeAllListeners();
        socket.disconnect();
        socket = null;
      }
      stopPolling();
      clearInactivityCheck();
      clearReconnectTimer();
      clearHeartbeat();
      reconnectAttempts = 0;
      saveSession();
      orders = [];
      lastSerialized = "";
      lastRealtimeUpdate = 0;
      renderCurrentView();
      clearOrderDraft();
      if (showLoginView) {
        showLogin();
      }
    }

    function clearReconnectTimer() {
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
    }

    function clearHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    function startHeartbeat() {
      clearHeartbeat();
      if (!socket || !socket.connected) return;
      
      let lastPongTime = Date.now();
      const PONG_TIMEOUT_MS = 10000; // 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
      
      // –°–ª—É—Ö–∞—î–º–æ pong –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è
      const pongHandler = () => {
        lastPongTime = Date.now();
      };
      socket.on("pong", pongHandler);
      
      heartbeatInterval = setInterval(() => {
        if (!socket || !socket.connected) {
          clearHeartbeat();
          attemptReconnect();
          return;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π ping
        const timeSinceLastPong = Date.now() - lastPongTime;
        if (timeSinceLastPong > PONG_TIMEOUT_MS) {
          console.debug("[heartbeat] pong timeout, reconnecting");
          clearHeartbeat();
          attemptReconnect();
          return;
        }
        
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ ping –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è
        try {
          socket.emit("ping");
        } catch (err) {
          console.debug("[heartbeat] ping failed:", err);
          clearHeartbeat();
          attemptReconnect();
        }
      }, HEARTBEAT_INTERVAL_MS);
    }

    function attemptReconnect() {
      if (!authToken) return;
      if (reconnectTimer) return; // –í–∂–µ –ø–ª–∞–Ω—É—î—Ç—å—Å—è –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
      
      if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
        setSyncStatus("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ä–µ–∂–∏–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.", true);
        startPolling("max reconnect attempts reached");
        return;
      }

      reconnectAttempts++;
      const delay = Math.min(RECONNECT_BASE_DELAY * Math.pow(2, reconnectAttempts - 1), 30000); // –ú–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥
      
      setSyncStatus(`–ü–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ ${Math.round(delay / 1000)}—Å... (—Å–ø—Ä–æ–±–∞ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, true);
      
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connectSocket(true);
      }, delay);
    }

    function connectSocket(forceReconnect = false) {
      if (!authToken) return;
      if (typeof io === "undefined") {
        startPolling("socket.io unavailable");
        return;
      }
      
      clearReconnectTimer();
      
      if (socket) {
        if (!forceReconnect && socket.connected) {
          return;
        }
        socket.removeAllListeners();
        socket.disconnect();
        socket = null;
      }
      
      try {
      socket = io({
          auth: { token: authToken },
          reconnection: false, // –í–∏–º–∏–∫–∞—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Socket.IO, —Ä–æ–±–∏–º–æ —Å–≤–æ—î
          transports: ["websocket", "polling"], // –î–æ–∑–≤–æ–ª—è—î–º–æ –æ–±–∏–¥–≤–∞ —Ç–∏–ø–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É
          timeout: 10000
      });
        
      socket.on("connect", () => {
          reconnectAttempts = 0; // –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ
        setSyncStatus("–û–Ω–ª–∞–π–Ω", false);
        scheduleInactivityCheck();
          startHeartbeat();
        if (pollTimer) {
          stopPolling();
        }
          // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
          refreshOrders(true).catch(() => {});
      });
        
      socket.on("orders_updated", data => {
        applyOrders(data, true);
      });
        
        socket.on("pong", () => {
          // –û—Ç—Ä–∏–º–∞–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ ping - –∑'—î–¥–Ω–∞–Ω–Ω—è –∂–∏–≤–µ
          touchRealtimeUpdate();
        });
        
        socket.on("disconnect", (reason) => {
          clearHeartbeat();
        clearInactivityCheck();
          
          if (reason === "io server disconnect") {
            // –°–µ—Ä–≤–µ—Ä –ø—Ä–∏–º—É—Å–æ–≤–æ —Ä–æ–∑—ñ—Ä–≤–∞–≤ –∑'—î–¥–Ω–∞–Ω–Ω—è, –Ω–µ –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è
            setSyncStatus("–ó'—î–¥–Ω–∞–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç–æ —Å–µ—Ä–≤–µ—Ä–æ–º", true);
            startPolling("server disconnect");
          } else {
            // –Ü–Ω—à—ñ –ø—Ä–∏—á–∏–Ω–∏ - –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è
            setSyncStatus("–ó'—î–¥–Ω–∞–Ω–Ω—è —Ä–æ–∑—ñ—Ä–≤–∞–Ω–æ. –ü–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...", true);
            attemptReconnect();
        startPolling("socket disconnected");
          }
      });
        
        socket.on("connect_error", (err) => {
          clearHeartbeat();
        const message = err && err.message ? err.message : "–ü–æ–º–∏–ª–∫–∞ WebSocket";
        setSyncStatus(message, true);
          attemptReconnect();
        startPolling("socket error");
      });
        
        socket.on("error", (err) => {
          console.error("[socket] error:", err);
          clearHeartbeat();
          attemptReconnect();
        });
        
      } catch (err) {
        console.error("[socket] connection failed:", err);
        setSyncStatus("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è", true);
        attemptReconnect();
        startPolling("connection exception");
      }
    }

    function setMode(mode, force = false) {
      if (mode === "analytics") {
        // Analytics –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –¥–ª—è admin
        if (!authToken || authRole !== "admin") {
          if (!force) {
            showLogin();
            selectRole("admin");
          }
          return;
        }
      } else {
        const requiredRole = mode === "screen" ? "screen" : "admin";
        if (!authToken || authRole !== requiredRole) {
          if (!force) {
            showLogin();
            selectRole(requiredRole);
          }
          return;
        }
      }

      currentMode = mode;

      // –∫–æ–ª–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –µ–∫—Ä–∞–Ω –≥–æ—Å—Ç–µ–π ‚Äì –ø–æ—á–∏–Ω–∞—î–º–æ –Ω–æ–≤—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–∞—Å—É –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
      if (mode === "screen") {
        screenStatsStartTime = Date.now();
      } else {
        screenStatsStartTime = null;
      }

      const loginView = document.getElementById("loginView");
      const adminView = document.getElementById("adminView");
      const screenView = document.getElementById("screenView");
      const analyticsView = document.getElementById("analyticsView");

      loginView.style.display = "none";
      adminView.style.display = mode === "admin" ? "block" : "none";
      screenView.style.display = mode === "screen" ? "flex" : "none";
      analyticsView.style.display = mode === "analytics" ? "block" : "none";

      if (mode === "admin") {
        location.hash = "#admin";
      } else if (mode === "screen") {
        location.hash = "#screen";
      } else if (mode === "analytics") {
        location.hash = "#analytics";
      } else {
        location.hash = "";
      }

      document.getElementById("logoutBtn").style.display = authRole === "admin" && mode !== "analytics" ? "inline-flex" : "none";
      document.getElementById("screenLogoutBtn").style.display = authRole === "screen" ? "inline-flex" : "none";

      // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
      updateMobileMenuVisibility();

      renderCurrentView();
    }

    function openScreenWindow() {
      if (authRole !== "admin") {
        alert("–§—É–Ω–∫—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏—à–µ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞–º.");
        return;
      }
      const base = location.href.split("?")[0].split("#")[0];
      const url = base + "?view=screen#screen";
      window.open(url, "_blank");
    }

    async function confirmClearAll() {
      const ok = confirm("–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è? –¶–µ –Ω–µ –º–æ–∂–Ω–∞ –±—É–¥–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏.");
      if (!ok) return;
      try {
        await apiRequest(API_BASE, { method: "DELETE" });
      } catch (err) {
        alert(err.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—á–∏—Å—Ç–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
      }
    }

    function formatOrderItemsHtml(order) {
      if (Array.isArray(order.items) && order.items.length) {
        return order.items
          .map(item => {
            const quantity = item.quantity || 0;
            const unitPrice = typeof item.unitPrice === "number" ? item.unitPrice : 0;
            return (
              '<div class="order-item-row">' +
              "<span>" +
              escapeHtml(item.label || "–ü–æ–∑–∏—Ü—ñ—è") +
              " √ó" +
              quantity +
              "</span>" +
              "<strong>" +
              formatPriceValue(unitPrice * quantity) +
              "</strong>" +
              "</div>"
            );
          })
          .join("");
      }
      const text = order.itemsText || "(–±–µ–∑ –æ–ø–∏—Å—É)";
      return escapeHtml(text).replace(/\n/g, "<br>");
    }

    function renderCurrentView() {
      if (currentMode === "admin") {
        renderAdminView();
      } else if (currentMode === "screen") {
        renderScreenView();
      } else if (currentMode === "analytics") {
        renderAnalyticsView();
      }
    }

    // –ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
    function matchesSearch(order, query) {
      if (!query) return true;
      const q = query.toLowerCase();
      const name = (order.name || "").toLowerCase();
      const number = String(order.number || "").toLowerCase();
      const itemsText = (order.itemsText || "").toLowerCase();
      const note = (order.note || "").toLowerCase();
      if (Array.isArray(order.items)) {
        const itemsLabels = order.items.map(i => (i.label || "").toLowerCase()).join(" ");
        return (
          name.includes(q) ||
          number.includes(q) ||
          itemsText.includes(q) ||
          note.includes(q) ||
          itemsLabels.includes(q)
        );
      }
      return name.includes(q) || number.includes(q) || itemsText.includes(q) || note.includes(q);
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll(".quick-action-btn").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-filter") === filter);
      });
      renderAdminView();
    }

    function performSearch(query) {
      searchQuery = query;
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }
      searchDebounceTimer = setTimeout(() => {
        renderAdminView();
      }, 300);
    }

    // –®–≤–∏–¥–∫–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    let lastOrderQuickTimer = null;
    function showLastOrderQuick() {
      if (!lastOrder) return;
      const quickEl = document.getElementById("lastOrderQuick");
      const contentEl = document.getElementById("lastOrderQuickContent");
      if (!quickEl || !contentEl) return;
      const name = lastOrder.name || "–ë–µ–∑ —ñ–º–µ–Ω—ñ";
      const items = lastOrder.itemsText || "(–±–µ–∑ –æ–ø–∏—Å—É)";
      const total = formatPriceValue(lastOrder.totalPrice || 0);
      contentEl.textContent = `${name} ‚Äî ${items.substring(0, 60)}${items.length > 60 ? "..." : ""} (${total})`;
      quickEl.classList.add("show");
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      if (lastOrderQuickTimer) {
        clearTimeout(lastOrderQuickTimer);
      }
      lastOrderQuickTimer = setTimeout(() => {
        hideLastOrderQuick();
      }, 5000);
    }

    function hideLastOrderQuick() {
      const quickEl = document.getElementById("lastOrderQuick");
      if (quickEl) {
        quickEl.classList.remove("show");
      }
    }

    function copyLastOrder() {
      if (!lastOrder) return;
      const nameInput = document.getElementById("orderName");
      const noteInput = document.getElementById("orderCustomNote");
      if (nameInput) {
        nameInput.value = lastOrder.name || "";
      }
      if (noteInput) {
        noteInput.value = lastOrder.note || "";
      }
      if (Array.isArray(lastOrder.items)) {
        builderState = {};
        manualExtras = [];
        lastOrder.items.forEach(item => {
          if (item.isManual) {
            manualExtraCounter += 1;
            manualExtras.push({
              id: "manual_" + manualExtraCounter,
              label: item.label,
              unitPrice: item.unitPrice,
              quantity: item.quantity
            });
          } else if (item.key && menuItemIndex.has(item.key)) {
            builderState[item.key] = item.quantity || 0;
          }
        });
        updateOrderPreview();
        renderManualExtras();
      }
      const clientPaidInput = document.getElementById("clientPaidInput");
      if (clientPaidInput && typeof lastOrder.clientPaid === "number") {
        clientPaidInput.value = lastOrder.clientPaid;
        updateOrderPreview();
      }
      hideLastOrderQuick();
      if (nameInput) {
        nameInput.focus();
      }
    }

    function renderAdminView() {
      const columnsRoot = document.getElementById("adminColumns");
      const statsText = document.getElementById("statsText");
      if (!columnsRoot || !statsText) return;

      const total = orders.length;
      const newCount = orders.filter(o => o.status === "new").length;
      const inProgressCount = orders.filter(o => o.status === "in_progress").length;
      const readyCount = orders.filter(o => o.status === "ready").length;
      const doneCount = orders.filter(o => o.status === "done").length;

      statsText.textContent =
        "–í—Å—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å: " +
        total +
        " | –ù–æ–≤—ñ: " +
        newCount +
        " | –í —Ä–æ–±–æ—Ç—ñ: " +
        inProgressCount +
        " | –ì–æ—Ç–æ–≤—ñ: " +
        readyCount +
        " | –í–∏–¥–∞–Ω—ñ: " +
        doneCount;

      renderStatusLegend();

      const now = Date.now();

      const html = statusConfig
        .map(sc => {
          let list = orders
            .filter(o => o.status === sc.key)
            .filter(o => {
              // –Ø–∫—â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ñ—ñ–ª—å—Ç—Ä, –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å
              if (currentFilter !== "all" && currentFilter !== sc.key) {
                return false;
              }
              // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –ø–æ—à—É–∫
              return matchesSearch(o, searchQuery);
            })
            .sort((a, b) => a.number - b.number);
          let hiddenCount = 0;

          if (sc.key === "done" && hideOldDone) {
            // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ —á–∞—Å–æ–º (–Ω–æ–≤—ñ—à—ñ —Å–ø–æ—á–∞—Ç–∫—É) —ñ –∑–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 5
            const sortedByTime = [...list].sort((a, b) => {
              const timeA = getDoneReferenceTimestamp(a);
              const timeB = getDoneReferenceTimestamp(b);
              return timeB - timeA; // –Ω–æ–≤—ñ—à—ñ —Å–ø–æ—á–∞—Ç–∫—É
            });
            const keepCount = 5; // –ó–∞–ª–∏—à–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ 5 –∑–∞–º–æ–≤–ª–µ–Ω—å
            const filtered = sortedByTime.slice(0, keepCount);
            hiddenCount = list.length - filtered.length;
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ (–∑–∞ –Ω–æ–º–µ—Ä–æ–º) –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            list = filtered.sort((a, b) => a.number - b.number);
          }

          const cards =
            list
              .map(o => {
                const number = o.number != null ? o.number : "?";
                const name = o.name || "–ë–µ–∑ —ñ–º–µ–Ω—ñ";
                const time = formatTime(o.createdAt);
                const itemsHtml = formatOrderItemsHtml(o);
                const financeParts = [];
                if (typeof o.totalPrice === "number") {
                  financeParts.push("–°—É–º–∞: " + formatPriceValue(o.totalPrice));
                }
                if (typeof o.clientPaid === "number") {
                  financeParts.push("–ö–ª—ñ—î–Ω—Ç –¥–∞–≤: " + formatPriceValue(o.clientPaid));
                }
                if (typeof o.changeDue === "number") {
                  financeParts.push("–†–µ—à—Ç–∞: " + formatPriceValue(o.changeDue));
                }
                const financeHtml = financeParts.length
                  ? '<div class="order-finance">' + financeParts.join(" ‚Ä¢ ") + "</div>"
                  : "";
                const noteHtml = o.note
                  ? '<div class="order-note">–ü–æ–±–∞–∂–∞–Ω–Ω—è: ' + escapeHtml(o.note) + "</div>"
                  : "";

                let buttons = "";

                const copyButton =
                  '<button class="btn small ghost" data-action="duplicate" data-id="' + o.id + '">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>';

                if (o.status === "new") {
                  buttons =
                    '<button class="btn small secondary" data-action="to_in_progress" data-id="' +
                    o.id +
                    '">–í —Ä–æ–±–æ—Ç—É</button>' +
                    '<button class="btn small" data-action="to_ready" data-id="' +
                    o.id +
                    '">–ì–æ—Ç–æ–≤–æ</button>' +
                    '<button class="btn small danger" data-action="delete" data-id="' +
                    o.id +
                    '">–í–∏–¥–∞–ª–∏—Ç–∏</button>' +
                    copyButton;
                } else if (o.status === "in_progress") {
                  buttons =
                    '<button class="btn small" data-action="to_ready" data-id="' +
                    o.id +
                    '">–ì–æ—Ç–æ–≤–æ</button>' +
                    '<button class="btn small secondary" data-action="to_new" data-id="' +
                    o.id +
                    '">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –Ω–æ–≤—ñ</button>' +
                    '<button class="btn small danger" data-action="delete" data-id="' +
                    o.id +
                    '">–í–∏–¥–∞–ª–∏—Ç–∏</button>';
                } else if (o.status === "ready") {
                  buttons =
                    '<button class="btn small" data-action="to_done" data-id="' +
                    o.id +
                    '">–í–∏–¥–∞–Ω—ñ</button>' +
                    '<button class="btn small secondary" data-action="to_in_progress" data-id="' +
                    o.id +
                    '">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ —Ä–æ–±–æ—Ç—É</button>';
                } else if (o.status === "done") {
                  buttons =
                    '<button class="btn small secondary" data-action="to_ready" data-id="' +
                    o.id +
                    '">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –≥–æ—Ç–æ–≤—ñ</button>' +
                    '<button class="btn small danger" data-action="delete" data-id="' +
                    o.id +
                    '">–í–∏–¥–∞–ª–∏—Ç–∏</button>' +
                    copyButton;
                }

                return (
                  '<div class="order-card">' +
                  '<div class="order-top">' +
                  '<div class="order-number">‚Ññ' +
                  escapeHtml(number) +
                  "</div>" +
                  '<div class="order-name">' +
                  escapeHtml(name) +
                  "</div>" +
                  '<div class="order-time">' +
                  escapeHtml(time) +
                  "</div>" +
                  "</div>" +
                  '<div class="order-items">' +
                  itemsHtml +
                  "</div>" +
                  financeHtml +
                  noteHtml +
                  '<div class="order-actions">' +
                  buttons +
                  "</div>" +
                  "</div>"
                );
              })
              .join("") || '<div class="empty">–ü–æ–∫–∏ –Ω–µ–º–∞—î</div>';

          const toggleButton =
            sc.key === "done"
              ? '<button class="text-button" data-action="toggle_done_filter">' +
                (hideOldDone ? "–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ" : "–°—Ö–æ–≤–∞—Ç–∏ —Å—Ç–∞—Ä—ñ") +
                "</button>"
              : "";
          const hiddenNote =
            sc.key === "done" && hiddenCount > 0
              ? '<div class="hint">–ü—Ä–∏—Ö–æ–≤–∞–Ω–æ ' +
                hiddenCount +
                " —Å—Ç–∞—Ä—ñ—à–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å. –ü–æ–∫–∞–∑–∞–Ω–æ –æ—Å—Ç–∞–Ω–Ω—ñ 5.</div>"
              : "";

          return (
            '<div class="status-column" data-status="' +
            sc.key +
            '">' +
            '<div class="status-title">' +
            '<span style="color:' +
            sc.color +
            ';">' +
            sc.title +
            "</span>" +
            '<span class="status-count">' +
            (searchQuery || currentFilter !== "all" ? list.length : orders.filter(o => o.status === sc.key).length) +
            "</span>" +
            toggleButton +
            "</div>" +
            '<div class="orders-list">' +
            cards +
            "</div>" +
            hiddenNote +
            "</div>"
          );
        })
        .join("");

      columnsRoot.innerHTML = html;
    }

    function renderScreenView() {
      const readyContainer = document.getElementById("readyContainer");
      const screenEmpty = document.getElementById("screenEmpty");
      const inProgressTextEl = document.getElementById("inProgressText");
      const waitTimeTextEl = document.getElementById("waitTimeText");
      const recentDoneEl = document.getElementById("recentDone");
      const inProgressContainer = document.getElementById("inProgressContainer");
      const inProgressTitleEl = document.getElementById("inProgressSectionTitle");
      if (!readyContainer || !screenEmpty) return;

      const readyOrders = orders
        .filter(o => o.status === "ready")
        .sort((a, b) => a.number - b.number);
      const inProgressOrders = orders
        .filter(o => o.status === "in_progress")
        .sort((a, b) => a.number - b.number);

      if (waitTimeTextEl) {
        const avg = calculateAverageWaitMinutes();
        if (avg) {
          waitTimeTextEl.textContent = "–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞—Ä–∞–∑ ~" + avg + " —Ö–≤–∏–ª–∏–Ω.";
        } else {
          // –Ø–∫—â–æ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö, –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ –Ω—ñ—á–æ–≥–æ –∞–±–æ –ø–æ–∫–∞–∑—É—î–º–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
          waitTimeTextEl.textContent = "";
        }
      }

      if (inProgressTextEl) {
        inProgressTextEl.textContent = describeInProgressOrders();
      }

      if (recentDoneEl) {
        const recentDone = orders
          .filter(o => o.status === "done")
          .sort((a, b) => getDoneReferenceTimestamp(b) - getDoneReferenceTimestamp(a))
          .slice(0, 3);
        if (recentDone.length) {
          const chips = recentDone
            .map(o => {
              const num = o.number != null ? o.number : "?";
              return '<span class="recent-done-item">‚Ññ' + escapeHtml(num) + " ‚úÖ –≤–∂–µ –≤–∏–¥–∞–Ω–æ</span>";
            })
            .join("");
          recentDoneEl.innerHTML = "–ù–µ—â–æ–¥–∞–≤–Ω–æ –≤–∏–¥–∞–Ω—ñ: " + chips;
        } else {
          recentDoneEl.textContent = "";
        }
      }

      // –≤–µ–ª–∏–∫—ñ –∫–∞—Ä—Ç–∫–∏ –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω—å, —è–∫—ñ –∑–∞—Ä–∞–∑ –≥–æ—Ç—É—é—Ç—å—Å—è
      if (inProgressContainer && inProgressTitleEl) {
        if (!inProgressOrders.length) {
          inProgressContainer.innerHTML = "";
          inProgressTitleEl.style.display = "none";
        } else {
          inProgressTitleEl.style.display = "block";
          const inProgressHtml = inProgressOrders
            .map(o => {
              const num = o.number != null ? o.number : "?";
              return (
                '<div class="inprogress-item">' +
                '<div class="inprogress-item-number">‚Ññ' +
                escapeHtml(num) +
                "</div>" +
                "</div>"
              );
            })
            .join("");
          inProgressContainer.innerHTML = inProgressHtml;
        }
      }

      if (!readyOrders.length) {
        readyContainer.innerHTML = "";
        screenEmpty.style.display = "block";
        pendingReadyHighlights.clear();
        return;
      }

      screenEmpty.style.display = "none";

      const html = readyOrders
        .map(o => {
          const num = o.number != null ? o.number : "?";
          const highlightClass = pendingReadyHighlights.has(o.id) ? " pop" : "";
          return '<div class="ready-item' + highlightClass + '">‚Ññ' + escapeHtml(num) + "</div>";
        })
        .join("");

      readyContainer.innerHTML = html;
      pendingReadyHighlights.clear();
    }

    function renderAnalyticsView() {
      const contentEl = document.getElementById("analyticsContent");
      if (!contentEl) return;

      const doneOrders = orders.filter(o => o.status === "done");
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayOrders = doneOrders.filter(o => o.doneAt && new Date(o.doneAt) >= today);

      // –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      const totalRevenue = doneOrders.reduce((sum, o) => sum + (o.totalPrice || 0), 0);
      const todayRevenue = todayOrders.reduce((sum, o) => sum + (o.totalPrice || 0), 0);
      const avgOrderValue = doneOrders.length > 0 ? totalRevenue / doneOrders.length : 0;

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∏–Ω–∞—Ö
      const hourStats = {};
      doneOrders.forEach(o => {
        if (o.doneAt) {
          const hour = new Date(o.doneAt).getHours();
          hourStats[hour] = (hourStats[hour] || 0) + 1;
        }
      });
      const peakHour = Object.keys(hourStats).reduce((a, b) => hourStats[a] > hourStats[b] ? a : b, null);

      // –¢–æ–ø –ø–æ–∑–∏—Ü—ñ—ó
      const itemStats = {};
      doneOrders.forEach(o => {
        if (Array.isArray(o.items)) {
          o.items.forEach(item => {
            const key = item.label || "–ù–µ–≤—ñ–¥–æ–º–æ";
            itemStats[key] = (itemStats[key] || 0) + (item.quantity || 0);
          });
        }
      });
      const topItems = Object.entries(itemStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      // –°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
      const waitTimes = doneOrders
        .filter(o => o.readyAt && o.createdAt)
        .map(o => (o.readyAt - o.createdAt) / 60000)
        .filter(t => t > 0 && t < 180); // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∞–Ω–æ–º–∞–ª—ñ—ó
      const avgWaitTime = waitTimes.length > 0
        ? Math.round(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length)
        : 0;

      // –°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ–±—Ä–æ–±–∫–∏ (–≤—ñ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ –≤–∏–¥–∞—á—ñ)
      const processingTimes = doneOrders
        .filter(o => o.doneAt && o.createdAt)
        .map(o => (o.doneAt - o.createdAt) / 60000)
        .filter(t => t > 0 && t < 300); // –î–æ 5 –≥–æ–¥–∏–Ω
      const avgProcessingTime = processingTimes.length > 0
        ? Math.round(processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length)
        : 0;

      // –ì—Ä–∞—Ñ—ñ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ—Å—Ç—ñ –ø–æ –≥–æ–¥–∏–Ω–∞—Ö (–¥–æ—Ö—ñ–¥)
      const hourRevenue = {};
      doneOrders.forEach(o => {
        if (o.doneAt) {
          const hour = new Date(o.doneAt).getHours();
          hourRevenue[hour] = (hourRevenue[hour] || 0) + (o.totalPrice || 0);
        }
      });
      const maxHourRevenue = Math.max(...Object.values(hourRevenue), 1);

      // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –¥–µ–Ω—å (–Ω–∞ –æ—Å–Ω–æ–≤—ñ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤)
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const weekOrders = doneOrders.filter(o => o.doneAt && new Date(o.doneAt) >= weekAgo);
      const avgDailyOrders = weekOrders.length > 0 ? Math.round(weekOrders.length / 7) : 0;
      const avgDailyRevenue = weekOrders.length > 0 
        ? weekOrders.reduce((sum, o) => sum + (o.totalPrice || 0), 0) / 7 
        : 0;

      const html = `
        <div class="analytics-grid">
          <div class="analytics-card">
            <div class="analytics-card-title">–í—Å—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å</div>
            <div class="analytics-card-value">${doneOrders.length}</div>
            <div class="analytics-card-subtitle">–í–∏–¥–∞–Ω–∏—Ö –∑–∞ –≤–µ—Å—å —á–∞—Å</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-card-title">–°—å–æ–≥–æ–¥–Ω—ñ</div>
            <div class="analytics-card-value">${todayOrders.length}</div>
            <div class="analytics-card-subtitle">–í–∏–¥–∞–Ω–∏—Ö —Å—å–æ–≥–æ–¥–Ω—ñ</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-card-title">–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥</div>
            <div class="analytics-card-value">${formatPriceValue(totalRevenue)}</div>
            <div class="analytics-card-subtitle">–í—Å—å–æ–≥–æ –∑–∞ –≤–µ—Å—å —á–∞—Å</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-card-title">–î–æ—Ö—ñ–¥ —Å—å–æ–≥–æ–¥–Ω—ñ</div>
            <div class="analytics-card-value">${formatPriceValue(todayRevenue)}</div>
            <div class="analytics-card-subtitle">–ó–∞ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—ñ–π –¥–µ–Ω—å</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-card-title">–°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫</div>
            <div class="analytics-card-value">${formatPriceValue(avgOrderValue)}</div>
            <div class="analytics-card-subtitle">–°–µ—Ä–µ–¥–Ω—è —Å—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-card-title">–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è</div>
            <div class="analytics-card-value">${avgWaitTime} —Ö–≤</div>
            <div class="analytics-card-subtitle">–ß–∞—Å –≤—ñ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-card-title">–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ–±—Ä–æ–±–∫–∏</div>
            <div class="analytics-card-value">${avgProcessingTime} —Ö–≤</div>
            <div class="analytics-card-subtitle">–ß–∞—Å –≤—ñ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ –≤–∏–¥–∞—á—ñ</div>
          </div>
          <div class="analytics-card">
            <div class="analytics-card-title">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞</div>
            <div class="analytics-card-value">${avgDailyOrders} –∑–∞–º–æ–≤–ª–µ–Ω—å</div>
            <div class="analytics-card-subtitle">~${formatPriceValue(avgDailyRevenue)} –¥–æ—Ö—ñ–¥ (—Å–µ—Ä–µ–¥–Ω—î –∑–∞ —Ç–∏–∂–¥–µ–Ω—å)</div>
          </div>
        </div>

        <div class="analytics-card">
          <div class="analytics-card-title">–ù–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à—ñ –ø–æ–∑–∏—Ü—ñ—ó</div>
          <div class="analytics-list">
            ${topItems.length > 0 ? topItems.map(([item, count]) => `
              <div class="analytics-list-item">
                <span class="analytics-list-item-label">${escapeHtml(item)}</span>
                <span class="analytics-list-item-value">${count} —à—Ç</span>
              </div>
            `).join("") : '<div class="hint">–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>'}
          </div>
        </div>

        <div class="analytics-card">
          <div class="analytics-card-title">–ù–∞–π–∞–∫—Ç–∏–≤–Ω—ñ—à–∞ –≥–æ–¥–∏–Ω–∞</div>
          <div class="analytics-card-value">${peakHour !== null ? peakHour + ":00" : "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö"}</div>
          <div class="analytics-card-subtitle">${peakHour !== null ? hourStats[peakHour] + " –∑–∞–º–æ–≤–ª–µ–Ω—å" : ""}</div>
          ${Object.keys(hourStats).length > 0 ? `
            <div class="analytics-chart">
              ${Object.entries(hourStats).sort((a, b) => a[0] - b[0]).map(([hour, count]) => `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <div style="min-width: 50px; font-size: 13px; color: #6b7280;">${hour}:00</div>
                  <div style="flex: 1; background: #e5e7eb; height: 24px; border-radius: 4px; position: relative;">
                    <div style="background: #2563eb; height: 100%; width: ${(count / Math.max(...Object.values(hourStats))) * 100}%; border-radius: 4px;"></div>
                  </div>
                  <div style="min-width: 40px; text-align: right; font-size: 13px; font-weight: 600;">${count}</div>
                </div>
              `).join("")}
            </div>
          ` : ""}
        </div>

        <div class="analytics-card">
          <div class="analytics-card-title">–ì—Ä–∞—Ñ—ñ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ—Å—Ç—ñ –ø–æ –≥–æ–¥–∏–Ω–∞—Ö (–¥–æ—Ö—ñ–¥)</div>
          ${Object.keys(hourRevenue).length > 0 ? `
            <div class="analytics-chart">
              ${Object.entries(hourRevenue).sort((a, b) => a[0] - b[0]).map(([hour, revenue]) => `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <div style="min-width: 50px; font-size: 13px; color: #6b7280;">${hour}:00</div>
                  <div style="flex: 1; background: #e5e7eb; height: 24px; border-radius: 4px; position: relative;">
                    <div style="background: #16a34a; height: 100%; width: ${(revenue / maxHourRevenue) * 100}%; border-radius: 4px;"></div>
                  </div>
                  <div style="min-width: 60px; text-align: right; font-size: 13px; font-weight: 600;">${formatPriceValue(revenue)}</div>
                </div>
              `).join("")}
            </div>
          ` : '<div class="hint">–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>'}
        </div>
      `;

      contentEl.innerHTML = html;
    }

    function setupAdminEvents() {
      const addOrderBtn = document.getElementById("addOrderBtn");
      const orderNameInput = document.getElementById("orderName");
      const orderItemsInput = document.getElementById("orderItems");
      const columnsRoot = document.getElementById("adminColumns");
      const menuBuilderRoot = document.getElementById("menuBuilder");
      const manualExtrasRoot = document.getElementById("manualExtrasList");
      const manualAddBtn = document.getElementById("manualItemAddBtn");
      const manualNameInput = document.getElementById("manualItemNameInput");
      const manualPriceInput = document.getElementById("manualItemPriceInput");
      const clearBuilderBtn = document.getElementById("clearBuilderBtn");
      const customNoteInput = document.getElementById("orderCustomNote");
      const clientPaidInput = document.getElementById("clientPaidInput");

      if (addOrderBtn) {
        addOrderBtn.addEventListener("click", async function () {
          const name = orderNameInput.value.trim();
          const items = orderItemsInput.value.trim();
          if (!items) {
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–ø–∏—à–∏ —Ö–æ—á —â–æ—Å—å —É –ø–æ–ª–µ '–©–æ –∑–∞–º–æ–≤–∏–ª–∏'.");
            return;
          }
          const summary = updateOrderSummary();
          const itemsPayload = summary.items;
          if (!itemsPayload.length) {
            alert("–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω—É –ø–æ–∑–∏—Ü—ñ—é.");
            return;
          }
          const noteEl = document.getElementById("orderCustomNote");
          const note = noteEl ? noteEl.value.trim() : "";
          const payload = {
            name,
            itemsText: items,
            items: itemsPayload,
            totalPrice: Math.round(summary.total * 100) / 100,
            clientPaid: summary.clientPaidValue,
            changeDue: summary.change,
            note
          };
          addOrderBtn.disabled = true;
          try {
            const response = await apiRequest(API_BASE, { method: "POST", body: payload });
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
            if (response && response.id) {
              lastOrder = response;
              showLastOrderQuick();
              // –í—ñ–¥–º—ñ—á–∞—î–º–æ, —â–æ —Ü–µ –º–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (—â–æ–± –Ω–µ –ø—Ä–æ–≥—Ä–∞–≤–∞—Ç–∏ –∑–≤—É–∫)
              localStorage.setItem("cafeLastCreatedOrderId", response.id);
            }
            // –î–æ–¥–∞—î–º–æ —ñ–º'—è –≤ —ñ—Å—Ç–æ—Ä—ñ—é
            if (name) {
              addToNameHistory(name);
            }
            orderItemsInput.value = "";
            orderNameInput.value = "";
            orderNameInput.focus();
            clearOrderDraft();
            await refreshOrders(true);
          } catch (err) {
            alert(err.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
          } finally {
            addOrderBtn.disabled = false;
          }
        });
      }

      // –ü–æ—à—É–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å
      const searchInput = document.getElementById("searchOrdersInput");
      if (searchInput) {
        searchInput.addEventListener("input", function (event) {
          performSearch(event.target.value.trim());
        });
      }

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
      setFilter("all");

      if (menuBuilderRoot) {
        menuBuilderRoot.addEventListener("click", event => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const action = target.getAttribute("data-action");
          const itemKey = target.getAttribute("data-item");
          if (!action || !itemKey) return;
          if (action === "increment") {
            adjustItemCount(itemKey, 1);
          } else if (action === "decrement") {
            adjustItemCount(itemKey, -1);
          }
        });
      }

      if (manualExtrasRoot) {
        manualExtrasRoot.addEventListener("click", event => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const action = target.getAttribute("data-manual-action");
          const manualId = target.getAttribute("data-manual-id");
          if (!action || !manualId) return;
          if (action === "increment") {
            adjustManualExtra(manualId, 1);
          } else if (action === "decrement") {
            adjustManualExtra(manualId, -1);
          } else if (action === "remove") {
            removeManualExtra(manualId);
          }
        });
      }

      if (manualAddBtn) {
        manualAddBtn.addEventListener("click", addManualExtraFromInput);
      }

      [manualNameInput, manualPriceInput].forEach(input => {
        if (!input) return;
        input.addEventListener("keydown", event => {
          if (event.key === "Enter") {
            event.preventDefault();
            addManualExtraFromInput();
          }
        });
      });

      if (clearBuilderBtn) {
        clearBuilderBtn.addEventListener("click", clearOrderDraft);
      }

      if (customNoteInput) {
        customNoteInput.addEventListener("input", updateOrderPreview);
      }

      if (clientPaidInput) {
        clientPaidInput.addEventListener("input", updateOrderPreview);
      }

      if (columnsRoot) {
        columnsRoot.addEventListener("click", async function (event) {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const action = target.getAttribute("data-action");
          if (!action) return;
          if (action === "toggle_done_filter") {
            toggleHideOldDone();
            return;
          }
          const id = target.getAttribute("data-id");
          if (!id) return;

          try {
            if (action === "delete") {
              const ok = confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?");
              if (!ok) return;
              await apiRequest(API_BASE + "/" + encodeURIComponent(id), { method: "DELETE" });
            } else if (action === "to_in_progress") {
              await apiRequest(API_BASE + "/" + encodeURIComponent(id), {
                method: "PATCH",
                body: { status: "in_progress" }
              });
            } else if (action === "to_new") {
              await apiRequest(API_BASE + "/" + encodeURIComponent(id), {
                method: "PATCH",
                body: { status: "new" }
              });
            } else if (action === "to_ready") {
              await apiRequest(API_BASE + "/" + encodeURIComponent(id), {
                method: "PATCH",
                body: { status: "ready" }
              });
            } else if (action === "to_done") {
              await apiRequest(API_BASE + "/" + encodeURIComponent(id), {
                method: "PATCH",
                body: { status: "done" }
              });
            } else if (action === "duplicate") {
              await duplicateOrder(id);
              return;
            }
            await refreshOrders(true);
          } catch (err) {
            alert(err.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
          }
        });
      }
    }

    function applyOrders(data, force = false) {
      const serialized = JSON.stringify(data || []);
      if (force || serialized !== lastSerialized) {
        const prevReadyIds = new Set(orders.filter(o => o.status === "ready").map(o => o.id));
        const prevNewIds = new Set(orders.filter(o => o.status === "new").map(o => o.id));
        
        orders = Array.isArray(data) ? data : [];
        lastSerialized = serialized;
        
        // –í–∏—è–≤–ª–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –≥–æ—Ç–æ–≤–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å
        const currentReadyIds = new Set(orders.filter(o => o.status === "ready").map(o => o.id));
        const freshReady = [];
        currentReadyIds.forEach(id => {
          if (!prevReadyIds.has(id)) {
            freshReady.push(id);
          }
        });
        if (freshReady.length) {
          handleFreshReadyOrders(freshReady);
        }
        
        // –í–∏—è–≤–ª–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –º–∏ –∞–¥–º—ñ–Ω —ñ –Ω–µ –º–∏ —ó—Ö —Å—Ç–≤–æ—Ä–∏–ª–∏)
        if (authRole === "admin") {
          const currentNewIds = new Set(orders.filter(o => o.status === "new").map(o => o.id));
          const freshNew = [];
          currentNewIds.forEach(id => {
            if (!prevNewIds.has(id)) {
              freshNew.push(id);
            }
          });
          if (freshNew.length) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –Ω–µ –º–∏ —â–æ–π–Ω–æ —Å—Ç–≤–æ—Ä–∏–ª–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            const lastCreated = localStorage.getItem("cafeLastCreatedOrderId");
            const isOurOrder = freshNew.some(id => id === lastCreated);
            if (!isOurOrder) {
              playNewOrderSound();
              // –í—ñ–±—Ä–æ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö
              if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
              }
            }
            localStorage.removeItem("cafeLastCreatedOrderId");
          }
        }
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é —ñ–º–µ–Ω
        orders.forEach(order => {
          if (order.name && order.name.trim()) {
            nameHistory.add(order.name.trim());
          }
        });
        updateNameSuggestions();
        
        renderCurrentView();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø—É–ª—è—Ä–Ω—ñ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó (—Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω—å —Ç–∞ –≤ admin —Ä–µ–∂–∏–º—ñ)
        if (force && currentMode === "admin") {
          // –û–Ω–æ–≤–ª—é—î–º–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
          setTimeout(() => {
            const newCombos = analyzePopularCombinations();
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –∑–º—ñ–Ω–∏
            const currentComboKeys = JSON.stringify(favoriteCombos.map(c => c.name).sort());
            const newComboKeys = JSON.stringify(newCombos.map(c => c.name).sort());
            if (currentComboKeys !== newComboKeys) {
              favoriteCombos = newCombos;
              saveFavoriteCombos();
              renderQuickCombos();
            }
          }, 1000);
        }
      }
      touchRealtimeUpdate();
      setSyncStatus("–û–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString());
    }

    async function refreshOrders(force = false) {
      if (!authToken) return;
      if (refreshPromise) {
        return refreshPromise;
      }
      setSyncStatus("–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...");
      refreshPromise = (async () => {
        try {
          const data = await apiRequest(API_BASE);
          applyOrders(data, force);
        } catch (err) {
          console.error("–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó", err);
          setSyncStatus(err.message || "–ù–µ–º–∞—î –∑–≤'—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.", true);
        } finally {
          refreshPromise = null;
        }
      })();
      return refreshPromise;
    }

    // –û–±—Ä–æ–±–∫–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ –≥—ñ–±–µ—Ä–Ω–∞—Ü—ñ—ó/—Å–Ω—É
    function handleVisibilityChange() {
      if (document.visibilityState === "visible") {
        // –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ—é - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è
        if (authToken && authRole) {
          // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–µ
          if (!socket || !socket.connected) {
            console.debug("[visibility] reconnecting after visibility change");
            reconnectAttempts = 0; // –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ
            connectSocket(true);
          } else {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
            refreshOrders(true).catch(() => {
              // –Ø–∫—â–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è, –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—è
              reconnectAttempts = 0;
              connectSocket(true);
            });
          }
        }
      }
    }

    function handleWindowFocus() {
      // –í—ñ–∫–Ω–æ –æ—Ç—Ä–∏–º–∞–ª–æ —Ñ–æ–∫—É—Å - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è
      if (authToken && authRole) {
        if (!socket || !socket.connected) {
          console.debug("[focus] reconnecting after window focus");
          reconnectAttempts = 0;
          connectSocket(true);
        } else {
          // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è
          refreshOrders(true).catch(() => {
            reconnectAttempts = 0;
            connectSocket(true);
          });
        }
      }
    }

    function handleOnline() {
      // –ú–µ—Ä–µ–∂–∞ –∑–Ω–æ–≤—É –¥–æ—Å—Ç—É–ø–Ω–∞
      if (authToken && authRole) {
        console.debug("[online] network restored, reconnecting");
        reconnectAttempts = 0;
        if (!socket || !socket.connected) {
          connectSocket(true);
        } else {
          refreshOrders(true).catch(() => {
            connectSocket(true);
          });
        }
        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –æ—Ñ–ª–∞–π–Ω —á–µ—Ä–≥—É
        setTimeout(() => syncOfflineQueue(), 1000);
      }
    }

    function handleOffline() {
      // –ú–µ—Ä–µ–∂–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
      setSyncStatus("–ú–µ—Ä–µ–∂–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞", true);
      startPolling("network offline");
    }

    document.addEventListener("DOMContentLoaded", function () {
      setupAdminEvents();
      renderMenuBuilder();
      renderManualExtras();
      updateOrderPreview();
      renderStatusLegend();
      
      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π
      loadFavoriteCombos();
      renderQuickCombos();
      loadNameHistory();
      loadQuickMode();
      loadOfflineQueue();
      
      // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –æ—Ñ–ª–∞–π–Ω —á–µ—Ä–≥—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
      if (navigator.onLine) {
        setTimeout(() => syncOfflineQueue(), 2000);
      }
      
      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–≤—É–∫—É
      try {
        const savedSound = localStorage.getItem("cafeSoundEnabled");
        if (savedSound !== null) {
          soundEnabled = JSON.parse(savedSound);
        }
        const savedVolume = localStorage.getItem("cafeSoundVolume");
        if (savedVolume !== null) {
          soundVolume = parseFloat(savedVolume) || 0.5;
        }
      } catch (err) {
        console.error("Failed to load sound settings:", err);
      }
      
      document.getElementById("loginButton").addEventListener("click", submitLogin);
      document.getElementById("passwordInput").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          submitLogin();
        }
      });

      // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è scroll to top —Ç–∞ –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
      window.addEventListener("scroll", handleScroll);
      window.addEventListener("resize", updateMobileMenuVisibility);
      updateMobileMenuVisibility();

      // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ –≥—ñ–±–µ—Ä–Ω–∞—Ü—ñ—ó
      document.addEventListener("visibilitychange", handleVisibilityChange);
      window.addEventListener("focus", handleWindowFocus);
      window.addEventListener("online", handleOnline);
      window.addEventListener("offline", handleOffline);

      loadSession();

      const initialViewParam = new URLSearchParams(location.search).get("view");
      const preferredView =
        initialViewParam === "screen" ? "screen" : initialViewParam === "admin" ? "admin" : null;

      if (authToken && authRole) {
        startSession(preferredView).catch(() => {
          logout();
        });
      } else {
        showLogin();
        if (preferredView) {
          selectRole(preferredView);
        }
      }
    });
  </script>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–∏–±–æ—Ä—É —Å–º–∞–∫—É —á–∞—é Lovare -->
  <div class="flavor-modal-overlay" id="flavorModalOverlay" onclick="closeFlavorModal()">
    <div class="flavor-modal" onclick="event.stopPropagation()">
      <div class="flavor-modal-title">–û–±–µ—Ä—ñ—Ç—å —Å–º–∞–∫ —á–∞—é Lovare</div>
      <div class="flavor-options" id="flavorOptions">
        <button type="button" class="flavor-option" data-flavor="1001 NIGHTS" onclick="selectFlavor('1001 NIGHTS')">1001 NIGHTS</button>
        <button type="button" class="flavor-option" data-flavor="ALPINE HERBS" onclick="selectFlavor('ALPINE HERBS')">ALPINE HERBS</button>
        <button type="button" class="flavor-option" data-flavor="CHAMPAGNE SPLASHES" onclick="selectFlavor('CHAMPAGNE SPLASHES')">CHAMPAGNE SPLASHES</button>
      </div>
      <div class="flavor-modal-actions">
        <button type="button" class="btn secondary" onclick="closeFlavorModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>
</body>
</html>

